<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>OTel Demo ‚Äî Architecture Guide</title>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: #f1f5f9;
    color: #1e293b;
    line-height: 1.6;
  }

  /* ‚îÄ‚îÄ Layout ‚îÄ‚îÄ */
  .layout { display: flex; min-height: 100vh; }

  /* ‚îÄ‚îÄ Sidebar ‚îÄ‚îÄ */
  .sidebar {
    width: 230px;
    background: #0f172a;
    color: #cbd5e1;
    position: fixed;
    height: 100vh;
    overflow-y: auto;
    z-index: 200;
    flex-shrink: 0;
    display: flex; flex-direction: column;
  }
  .sidebar-brand {
    padding: 22px 20px 18px;
    border-bottom: 1px solid #1e293b;
  }
  .sidebar-brand .logo { font-size: 13px; font-weight: 800; color: #f8fafc; letter-spacing: -0.02em; }
  .sidebar-brand .sub  { font-size: 11px; color: #475569; margin-top: 3px; }

  .nav-section { padding: 12px 0 4px; }
  .nav-section-label {
    font-size: 10px; font-weight: 700; text-transform: uppercase;
    letter-spacing: 0.08em; color: #334155; padding: 0 20px 6px;
  }
  .nav-link {
    display: flex; align-items: center; gap: 10px;
    padding: 7px 20px;
    color: #94a3b8; font-size: 12.5px; text-decoration: none;
    transition: all 0.12s; cursor: pointer;
  }
  .nav-link:hover { color: #f1f5f9; background: #1e293b; }
  .nav-link.active { color: #f1f5f9; background: #1e293b; border-left: 3px solid #3b82f6; padding-left: 17px; }
  .nav-num {
    width: 20px; height: 20px; border-radius: 5px;
    background: #1e293b; color: #64748b;
    font-size: 10px; font-weight: 700;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0;
  }

  /* ‚îÄ‚îÄ Top subnav ‚îÄ‚îÄ */
  #top-subnav {
    position: fixed;
    top: 0; left: 230px; right: 0;
    height: 40px;
    background: #ffffff;
    border-bottom: 1px solid #e2e8f0;
    z-index: 190;
    display: flex; align-items: center;
    padding: 0 52px; gap: 10px;
  }
  #topnav-title { font-size: 12px; font-weight: 600; color: #475569; white-space: nowrap; flex-shrink: 0; }
  .topnav-sep { color: #cbd5e1; font-size: 14px; flex-shrink: 0; }
  #topnav-pills { display: flex; gap: 5px; flex-wrap: nowrap; overflow-x: auto; min-width: 0; flex: 1; padding-bottom: 2px; }
  #topnav-pills::-webkit-scrollbar { height: 2px; }
  #topnav-pills::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 1px; }
  .snav-pill {
    font-size: 11px; font-weight: 500;
    padding: 3px 10px; border-radius: 999px;
    border: 1px solid #e2e8f0; color: #64748b;
    text-decoration: none; background: transparent;
    transition: background 0.12s, color 0.12s, border-color 0.12s;
    white-space: nowrap; flex-shrink: 0; cursor: pointer;
  }
  .snav-pill:hover { background: #f1f5f9; color: #1e293b; border-color: #cbd5e1; }
  .snav-pill.active { background: #3b82f6; color: white; border-color: #3b82f6; }

  /* ‚îÄ‚îÄ Main ‚îÄ‚îÄ */
  .main { margin-left: 230px; flex: 1; padding: 60px 52px 80px; max-width: 920px; }

  /* ‚îÄ‚îÄ Page header ‚îÄ‚îÄ */
  .page-header { margin-bottom: 36px; }
  .page-header h1 { font-size: 28px; font-weight: 800; color: #0f172a; letter-spacing: -0.03em; }
  .page-header .lead { color: #374151; margin-top: 8px; font-size: 15px; max-width: 620px; }
  .tag-row { display: flex; gap: 8px; margin-top: 14px; flex-wrap: wrap; }
  .tag { font-size: 11px; font-weight: 600; padding: 3px 10px; border-radius: 20px; border: 1px solid; }
  .tag-blue   { background: #eff6ff; color: #2563eb; border-color: #bfdbfe; }
  .tag-green  { background: #f0fdf4; color: #16a34a; border-color: #bbf7d0; }
  .tag-purple { background: #faf5ff; color: #7c3aed; border-color: #e9d5ff; }
  .tag-slate  { background: #f8fafc; color: #475569; border-color: #e2e8f0; }
  .tag-amber  { background: #fffbeb; color: #d97706; border-color: #fde68a; }
  .tag-rose   { background: #fff1f2; color: #e11d48; border-color: #fecdd3; }

  /* ‚îÄ‚îÄ Section ‚îÄ‚îÄ */
  .section { margin-bottom: 52px; scroll-margin-top: 56px; }
  .section-header { display: flex; align-items: center; gap: 12px; margin-bottom: 20px; }
  .section-num {
    width: 34px; height: 34px; border-radius: 9px;
    color: #f8fafc; font-size: 14px; font-weight: 800;
    display: flex; align-items: center; justify-content: center; flex-shrink: 0;
  }
  .blue   { background: #2563eb; }
  .teal   { background: #0d9488; }
  .purple { background: #7c3aed; }
  .amber  { background: #d97706; }
  .green  { background: #16a34a; }
  .rose   { background: #e11d48; }
  .sky    { background: #0284c7; }
  .slate  { background: #475569; }
  .orange { background: #ea580c; }

  .section-header h2 { font-size: 20px; font-weight: 700; color: #0f172a; letter-spacing: -0.02em; }
  .section-sub { font-size: 13px; color: #475569; margin-top: 1px; }
  hr.divider { border: none; border-top: 1px solid #e2e8f0; margin: 40px 0; }

  /* ‚îÄ‚îÄ Section body (white content wrapper) ‚îÄ‚îÄ */
  .section-body {
    background: white; border: 1px solid #e2e8f0; border-radius: 14px;
    padding: 24px 28px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
  }

  /* ‚îÄ‚îÄ Card ‚îÄ‚îÄ */
  .card {
    background: white; border: 1px solid #e2e8f0; border-radius: 12px;
    padding: 20px 24px; margin-bottom: 12px;
  }
  .card h3 { font-size: 14px; font-weight: 700; color: #0f172a; margin-bottom: 6px; }
  .card p  { font-size: 13px; color: #1e293b; line-height: 1.65; }
  .card ul, .card ol { padding-left: 18px; margin-top: 6px; }
  .card li { font-size: 13px; color: #1e293b; margin-bottom: 4px; line-height: 1.5; }
  /* Cards inside a section-body use a faint bg so they lift off the white */
  .section-body .card { background: #f8fafc; }
  /* Inline code in body text */
  p code, li code, .step-body code, .alert code, .tip code {
    font-family: 'SF Mono','Fira Code','Consolas',monospace;
    font-size: 12px; background: #f1f5f9; padding: 1px 6px;
    border-radius: 4px; color: #0f172a; border: 1px solid #e2e8f0;
  }

  .card-grid { display: grid; gap: 12px; }
  .card-grid.cols-2 { grid-template-columns: 1fr 1fr; }
  .card-grid.cols-3 { grid-template-columns: 1fr 1fr 1fr; }

  /* ‚îÄ‚îÄ Code block (VSCode Dark+ theme) ‚îÄ‚îÄ */
  .code-wrap {
    border-radius: 8px; overflow: hidden;
    border: 1px solid #2d2d2d; margin: 12px 0;
  }
  .code-header {
    display: flex; align-items: center; justify-content: space-between;
    background: #2d2d2d; padding: 7px 14px;
    border-bottom: 1px solid #1e1e1e;
  }
  .code-header .lang-label {
    font-size: 11px; font-weight: 600; letter-spacing: 0.05em;
    text-transform: uppercase; color: #9cdcfe; font-family: 'SF Mono','Fira Code','Consolas',monospace;
  }
  .code-header .lang-label.sh { color: #4ec9b0; }
  .code-header .lang-label.json { color: #ce9178; }
  .code {
    background: #1e1e1e; color: #d4d4d4;
    padding: 16px 18px;
    font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
    font-size: 12.5px; line-height: 1.8; margin: 0;
    overflow-x: auto; white-space: pre;
  }
  /* VSCode Dark+ syntax colors */
  .code .c  { color: #6a9955; font-style: italic; }   /* comments ‚Äî green */
  .code .k  { color: #569cd6; }                        /* keywords ‚Äî blue */
  .code .s  { color: #ce9178; }                        /* strings ‚Äî orange-brown */
  .code .p  { color: #c586c0; }                        /* annotations ‚Äî purple */
  .code .fn { color: #dcdcaa; }                        /* functions ‚Äî yellow */
  .code .cl { color: #4ec9b0; }                        /* classes/types ‚Äî teal */
  .code .n  { color: #b5cea8; }                        /* numbers ‚Äî light green */
  .code .cmd { color: #d4d4d4; }                       /* shell commands */
  .code .flag { color: #9cdcfe; }                      /* shell flags ‚Äî light blue */
  .code .prompt { color: #4ec9b0; user-select: none; } /* $ prompt */
  .copy-btn {
    background: #3c3c3c; border: 1px solid #555;
    color: #9d9d9d; padding: 3px 10px; border-radius: 4px;
    font-size: 10px; cursor: pointer; transition: all 0.12s; font-family: inherit;
  }
  .copy-btn:hover { background: #4e4e4e; color: #d4d4d4; }

  /* ‚îÄ‚îÄ Steps ‚îÄ‚îÄ */
  .steps { display: flex; flex-direction: column; gap: 14px; }
  .step  { display: flex; gap: 14px; align-items: flex-start; }
  .step-circle {
    width: 28px; height: 28px; border-radius: 50%;
    background: #f1f5f9; border: 2px solid #e2e8f0;
    font-size: 12px; font-weight: 700; color: #334155;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0; margin-top: 1px;
  }
  .step-body strong { display: block; font-size: 13px; font-weight: 700; color: #0f172a; margin-bottom: 3px; }
  .step-body p { font-size: 13px; color: #1e293b; line-height: 1.6; }
  .step-body code { font-family: 'SF Mono','Fira Code',monospace; font-size: 11.5px; background: #f1f5f9; padding: 1px 6px; border-radius: 4px; color: #0f172a; }

  /* ‚îÄ‚îÄ Flow diagram ‚îÄ‚îÄ */
  .flow-row {
    display: flex; align-items: center; gap: 0;
    background: white; border: 1px solid #e2e8f0;
    border-radius: 12px; padding: 20px 28px; margin-bottom: 12px;
    overflow-x: auto;
  }
  .flow-box {
    background: #f8fafc; border: 1px solid #e2e8f0;
    border-radius: 8px; padding: 10px 16px;
    text-align: center; flex-shrink: 0;
  }
  .flow-box .fb-name { font-size: 13px; font-weight: 700; color: #0f172a; }
  .flow-box .fb-type { font-size: 11px; color: #475569; margin-top: 2px; }
  .flow-arrow { color: #cbd5e1; font-size: 18px; padding: 0 10px; flex-shrink: 0; }

  /* ‚îÄ‚îÄ Two-column ‚îÄ‚îÄ */
  .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; align-items: start; }

  /* ‚îÄ‚îÄ Alert ‚îÄ‚îÄ */
  .alert {
    display: flex; gap: 10px; padding: 12px 16px;
    border-radius: 8px; font-size: 13px; margin-bottom: 12px; line-height: 1.55;
  }
  .alert-info    { background: #eff6ff; border: 1px solid #bfdbfe; color: #1d4ed8; }
  .alert-success { background: #f0fdf4; border: 1px solid #bbf7d0; color: #166534; }
  .alert-warn    { background: #fff7ed; border: 1px solid #fed7aa; color: #c2410c; }

  /* ‚îÄ‚îÄ Tip ‚îÄ‚îÄ */
  .tip {
    display: flex; gap: 10px; padding: 11px 15px;
    background: #fffbeb; border: 1px solid #fde68a;
    border-radius: 8px; font-size: 12.5px; color: #92400e;
    margin-bottom: 10px; line-height: 1.5;
  }

  /* ‚îÄ‚îÄ Table ‚îÄ‚îÄ */
  .data-table { width: 100%; border-collapse: collapse; font-size: 13px; background: white; border-radius: 10px; overflow: hidden; border: 1px solid #e2e8f0; }
  .data-table th { text-align: left; padding: 10px 14px; background: #f8fafc; color: #1e293b; font-weight: 700; border-bottom: 2px solid #e2e8f0; }
  .data-table td { padding: 10px 14px; border-bottom: 1px solid #f1f5f9; color: #1e293b; vertical-align: top; }
  .data-table tr:last-child td { border-bottom: none; }
  .data-table code { font-family: 'SF Mono','Fira Code',monospace; background: #f1f5f9; padding: 2px 6px; border-radius: 4px; font-size: 11.5px; color: #0f172a; }

  /* ‚îÄ‚îÄ Stack list ‚îÄ‚îÄ */
  .stack-list { display: flex; flex-direction: column; gap: 8px; }
  .stack-item {
    background: white; border: 1px solid #e2e8f0; border-radius: 8px;
    padding: 12px 16px; display: flex; align-items: center; justify-content: space-between;
  }
  .stack-item .si-name { font-size: 13px; font-weight: 600; color: #0f172a; }
  .stack-item .si-role { font-size: 12px; color: #475569; }

  /* ‚îÄ‚îÄ Obs pipeline ‚îÄ‚îÄ */
  .pipeline {
    background: white; border: 1px solid #e2e8f0; border-radius: 12px;
    padding: 24px 28px; margin-bottom: 12px;
  }
  .pipeline-row { display: flex; align-items: center; gap: 14px; margin-bottom: 8px; }
  .pipeline-label { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: .07em; color: #475569; width: 80px; flex-shrink: 0; }
  .pipeline-nodes { display: flex; gap: 8px; flex-wrap: wrap; }
  .pnode {
    background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px;
    padding: 6px 14px; font-size: 13px; font-weight: 600; color: #334155;
  }
  .pnode.blue   { background: #eff6ff; border-color: #bfdbfe; color: #1d4ed8; }
  .pnode.green  { background: #f0fdf4; border-color: #bbf7d0; color: #166534; }
  .pnode.amber  { background: #fffbeb; border-color: #fde68a; color: #92400e; }
  .pnode.purple { background: #faf5ff; border-color: #e9d5ff; color: #6d28d9; }
  .pnode.rose   { background: #fff1f2; border-color: #fecdd3; color: #be123c; }
  .pnode.orange { background: #fff7ed; border-color: #fed7aa; color: #c2410c; }
  .pipeline-down { text-align: center; font-size: 16px; color: #cbd5e1; margin: 4px 0 8px 94px; }

  /* ‚îÄ‚îÄ Check list ‚îÄ‚îÄ */
  .check-list { list-style: none; padding: 0; }
  .check-list li { padding: 5px 0 5px 24px; position: relative; font-size: 13px; color: #475569; }
  .check-list li::before { content: '‚úì'; position: absolute; left: 0; color: #16a34a; font-weight: 700; }

  /* ‚îÄ‚îÄ Footer ‚îÄ‚îÄ */
  .footer { margin-top: 64px; padding-top: 20px; border-top: 1px solid #e2e8f0; font-size: 11.5px; color: #94a3b8; }

  h3[id], .section { scroll-margin-top: 56px; }

  /* ‚îÄ‚îÄ Hamburger button ‚îÄ‚îÄ */
  #hamburger {
    display: none; align-items: center; justify-content: center;
    width: 32px; height: 32px; border-radius: 6px;
    background: none; border: none; cursor: pointer;
    color: #475569; flex-shrink: 0; transition: background 0.12s;
  }
  #hamburger:hover { background: #f1f5f9; color: #0f172a; }
  #hamburger svg { display: block; }

  /* ‚îÄ‚îÄ Sidebar overlay ‚îÄ‚îÄ */
  #sidebar-overlay {
    display: none; position: fixed; inset: 0;
    background: rgba(15,23,42,0.45); z-index: 199;
  }
  #sidebar-overlay.open { display: block; }

  /* ‚îÄ‚îÄ Search trigger button (top-nav) ‚îÄ‚îÄ */
  #search-trigger {
    display: flex; align-items: center; gap: 6px;
    margin-left: auto; flex-shrink: 0;
    background: #f8fafc; border: 1px solid #e2e8f0;
    border-radius: 6px; padding: 4px 10px; cursor: pointer;
    font-size: 12px; color: #64748b; transition: all 0.12s;
  }
  #search-trigger:hover { border-color: #94a3b8; color: #0f172a; background: #f1f5f9; }
  #search-trigger .st-kbd {
    background: #e2e8f0; border-radius: 3px;
    padding: 1px 5px; font-size: 10px; font-family: monospace; color: #475569;
  }

  /* ‚îÄ‚îÄ Search modal ‚îÄ‚îÄ */
  #search-overlay {
    display: none; position: fixed; inset: 0;
    background: rgba(15,23,42,0.55); z-index: 400;
    align-items: flex-start; justify-content: center;
    padding-top: 80px;
  }
  #search-overlay.open { display: flex; }
  #search-box {
    background: white; border-radius: 12px;
    width: 580px; max-width: 92vw;
    box-shadow: 0 24px 64px rgba(0,0,0,0.3);
    overflow: hidden; display: flex; flex-direction: column;
  }
  #search-input-wrap {
    display: flex; align-items: center; gap: 10px;
    padding: 14px 18px; border-bottom: 1px solid #e2e8f0;
  }
  #search-input-wrap svg { color: #94a3b8; flex-shrink: 0; }
  #search-input {
    flex: 1; border: none; outline: none;
    font-size: 15px; color: #0f172a; background: transparent;
    font-family: inherit;
  }
  #search-input::placeholder { color: #94a3b8; }
  #search-clear {
    background: #f1f5f9; border: none; cursor: pointer;
    color: #64748b; border-radius: 4px; padding: 2px 8px;
    font-size: 11px; display: none;
  }
  #search-clear.visible { display: block; }
  #search-results { max-height: 380px; overflow-y: auto; }
  .sr-item {
    display: flex; gap: 12px; align-items: flex-start;
    padding: 11px 18px; cursor: pointer; border-bottom: 1px solid #f8fafc;
    transition: background 0.1s;
  }
  .sr-item:last-child { border-bottom: none; }
  .sr-item:hover, .sr-item.selected { background: #f1f5f9; }
  .sr-icon {
    width: 28px; height: 28px; border-radius: 7px;
    display: flex; align-items: center; justify-content: center;
    font-size: 13px; flex-shrink: 0; margin-top: 1px;
    background: #f1f5f9; border: 1px solid #e2e8f0;
  }
  .sr-body { min-width: 0; }
  .sr-title { font-size: 13px; font-weight: 700; color: #0f172a; }
  .sr-sub   { font-size: 12px; color: #475569; margin-top: 2px; line-height: 1.5; }
  .sr-sub mark, .sr-title mark {
    background: #fef08a; color: #0f172a;
    border-radius: 2px; padding: 0 2px; font-style: normal;
  }
  #search-empty {
    padding: 36px 20px; text-align: center;
    color: #94a3b8; font-size: 13px; display: none;
  }
  #search-empty.visible { display: block; }
  #search-footer {
    padding: 8px 18px; border-top: 1px solid #e2e8f0;
    display: flex; gap: 16px; align-items: center;
  }
  .sf-hint { font-size: 11px; color: #94a3b8; display: flex; align-items: center; gap: 4px; }
  .sf-kbd {
    background: #f1f5f9; border: 1px solid #e2e8f0;
    border-radius: 3px; padding: 1px 5px;
    font-size: 10px; font-family: monospace; color: #475569;
  }

  /* ‚îÄ‚îÄ Responsive ‚îÄ‚îÄ */
  @media (max-width: 768px) {
    .sidebar {
      transform: translateX(-100%);
      transition: transform 0.22s ease;
    }
    .sidebar.open { transform: translateX(0); }
    #hamburger { display: flex; }
    #top-subnav { left: 0; padding: 0 12px; }
    #topnav-title, .topnav-sep { display: none; }
    .main { margin-left: 0; padding: 56px 16px 60px; max-width: 100%; }
    #search-trigger .st-kbd { display: none; }
    .two-col { grid-template-columns: 1fr; }
    .card-grid.cols-3 { grid-template-columns: 1fr; }
    .card-grid.cols-2 { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>
<div class="layout">

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       SIDEBAR
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <nav class="sidebar">
    <div class="sidebar-brand">
      <div class="logo">OTel Demo Service</div>
      <div class="sub">Architecture Guide</div>
    </div>

    <div class="nav-section">
      <div class="nav-section-label">Overview</div>
      <a class="nav-link active" onclick="goTo('intro')">
        <span class="nav-num">‚òÖ</span> Introduction
      </a>
    </div>

    <div class="nav-section">
      <div class="nav-section-label">Architecture</div>
      <a class="nav-link" onclick="goTo('stack')">
        <span class="nav-num">1</span> Tech Stack
      </a>
      <a class="nav-link" onclick="goTo('layers')">
        <span class="nav-num">2</span> Layered Architecture
      </a>
      <a class="nav-link" onclick="goTo('domain')">
        <span class="nav-num">3</span> Domain Model
      </a>
      <a class="nav-link" onclick="goTo('tsid')">
        <span class="nav-num">4</span> TSID ID Generation
      </a>
    </div>

    <div class="nav-section">
      <div class="nav-section-label">Patterns</div>
      <a class="nav-link" onclick="goTo('api')">
        <span class="nav-num">5</span> REST API Layer
      </a>
      <a class="nav-link" onclick="goTo('events')">
        <span class="nav-num">6</span> Event Publishing
      </a>
      <a class="nav-link" onclick="goTo('errors')">
        <span class="nav-num">7</span> Error Handling
      </a>
      <a class="nav-link" onclick="goTo('json')">
        <span class="nav-num">8</span> JsonUtils
      </a>
    </div>

    <div class="nav-section">
      <div class="nav-section-label">Operations</div>
      <a class="nav-link" onclick="goTo('otel')">
        <span class="nav-num">9</span> OpenTelemetry
      </a>
      <a class="nav-link" onclick="goTo('testing')">
        <span class="nav-num">10</span> Testing Strategy
      </a>
      <a class="nav-link" onclick="goTo('infra')">
        <span class="nav-num">11</span> Infrastructure
      </a>
      <a class="nav-link" onclick="goTo('dataflow')">
        <span class="nav-num">12</span> Data Flow
      </a>
    </div>
  </nav>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       TOP SUBNAV
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <!-- Search modal -->
  <div id="search-overlay" onclick="closeSearch(event)">
    <div id="search-box" role="dialog" aria-modal="true" aria-label="Search">
      <div id="search-input-wrap">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
        <input id="search-input" type="text" placeholder="Search sections, patterns, concepts‚Ä¶" autocomplete="off" oninput="onSearchInput()" onkeydown="onSearchKey(event)"/>
        <button id="search-clear" onclick="clearSearch()">Clear</button>
      </div>
      <div id="search-results"></div>
      <div id="search-empty">No results for "<span id="search-query-label"></span>"</div>
      <div id="search-footer">
        <span class="sf-hint"><span class="sf-kbd">‚Üë‚Üì</span> navigate</span>
        <span class="sf-hint"><span class="sf-kbd">‚Üµ</span> jump</span>
        <span class="sf-hint"><span class="sf-kbd">Esc</span> close</span>
      </div>
    </div>
  </div>

  <!-- Sidebar overlay (mobile) -->
  <div id="sidebar-overlay" onclick="closeSidebar()"></div>

  <div id="top-subnav">
    <button id="hamburger" onclick="toggleSidebar()" aria-label="Toggle navigation">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
        <line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/>
      </svg>
    </button>
    <span id="topnav-title">Architecture</span>
    <span class="topnav-sep">/</span>
    <div id="topnav-pills">
      <a class="snav-pill active" onclick="goTo('stack')">Tech Stack</a>
      <a class="snav-pill" onclick="goTo('layers')">Layers</a>
      <a class="snav-pill" onclick="goTo('domain')">Domain Model</a>
      <a class="snav-pill" onclick="goTo('tsid')">TSID</a>
      <a class="snav-pill" onclick="goTo('api')">REST API</a>
      <a class="snav-pill" onclick="goTo('events')">Events</a>
      <a class="snav-pill" onclick="goTo('errors')">Errors</a>
      <a class="snav-pill" onclick="goTo('json')">JsonUtils</a>
      <a class="snav-pill" onclick="goTo('otel')">OTel</a>
      <a class="snav-pill" onclick="goTo('testing')">Testing</a>
      <a class="snav-pill" onclick="goTo('infra')">Infra</a>
      <a class="snav-pill" onclick="goTo('dataflow')">Data Flow</a>
    </div>
    <button id="search-trigger" onclick="openSearch()" title="Search (‚åòK)">
      <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
      Search
      <span class="st-kbd">‚åòK</span>
    </button>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       MAIN CONTENT
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <main class="main">

    <!-- Page header -->
    <div class="page-header" id="intro">
      <h1>OTel Demo ‚Äî Architecture Guide</h1>
      <p class="lead">A Spring Boot 3 microservice demonstrating end-to-end observability with distributed tracing, metrics, and structured logging via OpenTelemetry.</p>
      <div class="tag-row">
        <span class="tag tag-blue">Java 21</span>
        <span class="tag tag-purple">Spring Boot 3.4.2</span>
        <span class="tag tag-green">OpenTelemetry</span>
        <span class="tag tag-amber">Kafka</span>
        <span class="tag tag-rose">PostgreSQL</span>
        <span class="tag tag-slate">Testcontainers</span>
      </div>
    </div>

    <div class="alert alert-info">
      <span>‚ÑπÔ∏è</span>
      <span><strong>Purpose:</strong> This service is a working reference implementation for distributed tracing, Kafka event publishing, PostgreSQL JSONB storage, and RFC 7807 error handling in a real Spring Boot microservice.</span>
    </div>

    <hr class="divider"/>

    <!-- ‚îÄ‚îÄ 1. Tech Stack ‚îÄ‚îÄ -->
    <div class="section" id="stack">
      <div class="section-header">
        <div class="section-num blue">1</div>
        <div>
          <h2>Tech Stack</h2>
          <div class="section-sub">Key libraries and their roles</div>
        </div>
      </div>

      <div class="section-body">
        <div class="stack-list">
          <div class="stack-item"><span class="si-name">Spring Boot 3.4.2 ‚Äî Web, Data JPA, Kafka, Validation, Actuator</span><span class="si-role">Core framework</span></div>
          <div class="stack-item"><span class="si-name">PostgreSQL 15 + Flyway</span><span class="si-role">Persistence &amp; schema migrations</span></div>
          <div class="stack-item"><span class="si-name">Hypersistence TSID</span><span class="si-role">Time-sortable distributed IDs</span></div>
          <div class="stack-item"><span class="si-name">Apache Kafka (KRaft) + CloudEvents 4.0</span><span class="si-role">Event streaming</span></div>
          <div class="stack-item"><span class="si-name">OpenTelemetry Java Agent 2.12 + OTLP exporter</span><span class="si-role">Auto-instrumentation</span></div>
          <div class="stack-item"><span class="si-name">Jackson + Jayway JsonPath + json-smart</span><span class="si-role">JSON utilities</span></div>
          <div class="stack-item"><span class="si-name">Springdoc OpenAPI 2.8</span><span class="si-role">API docs / Swagger UI</span></div>
          <div class="stack-item"><span class="si-name">Testcontainers (PostgreSQL + Kafka)</span><span class="si-role">Integration testing</span></div>
        </div>
      </div>
    </div>

    <hr class="divider"/>

    <!-- ‚îÄ‚îÄ 2. Layered Architecture ‚îÄ‚îÄ -->
    <div class="section" id="layers">
      <div class="section-header">
        <div class="section-num teal">2</div>
        <div>
          <h2>Layered Architecture</h2>
          <div class="section-sub">Request flow and component responsibilities</div>
        </div>
      </div>

      <div class="section-body">
      <div class="flow-row" style="border:none; padding:16px 0 8px; box-shadow:none; background:transparent;">
        <div class="flow-box">
          <div class="fb-name">CustomerController</div>
          <div class="fb-type">REST Layer</div>
        </div>
        <div class="flow-arrow">‚Üí</div>
        <div class="flow-box">
          <div class="fb-name">CustomerService</div>
          <div class="fb-type">Business Logic</div>
        </div>
        <div class="flow-arrow">‚Üí</div>
        <div class="flow-box">
          <div class="fb-name">CustomerRepository</div>
          <div class="fb-type">Data Layer</div>
        </div>
        <div class="flow-arrow">‚Üí</div>
        <div class="flow-box">
          <div class="fb-name">PostgreSQL</div>
          <div class="fb-type">Database</div>
        </div>
      </div>

      <div class="flow-row" style="border:none; padding:0 0 8px; box-shadow:none; background:transparent;">
        <div style="width:152px; opacity:0; flex-shrink:0;"></div>
        <div class="flow-arrow" style="opacity:0;">‚Üí</div>
        <div class="flow-box">
          <div class="fb-name">EventPublisher</div>
          <div class="fb-type">Kafka side-effect</div>
        </div>
        <div class="flow-arrow">‚Üí</div>
        <div class="flow-box">
          <div class="fb-name">Kafka Topic</div>
          <div class="fb-type">customer-events</div>
        </div>
      </div>

      <div class="alert alert-success" style="margin-top:8px; margin-bottom:0;">
        <span>‚úì</span>
        <span><strong>Rule:</strong> The service layer is the only component that talks to both the repository and the event publisher. Controllers never access the repository directly.</span>
      </div>
      </div><!-- /section-body -->
    </div>

    <hr class="divider"/>

    <!-- ‚îÄ‚îÄ 3. Domain Model ‚îÄ‚îÄ -->
    <div class="section" id="domain">
      <div class="section-header">
        <div class="section-num purple">3</div>
        <div>
          <h2>Domain Model</h2>
          <div class="section-sub">Two representations of a Customer</div>
        </div>
      </div>

      <div class="two-col">
        <div>
          <div class="card" style="border-top:3px solid #2563eb;">
            <h3>Customer <span style="font-weight:400; color:#94a3b8; font-size:12px;">‚Äî Java Record</span></h3>
            <p>The domain object. Immutable Java record with nested value records: <code>Address</code>, <code>Email</code>, <code>Phone</code>, <code>Document</code>. Used by the REST API and service layer. All fields carry <strong>JSR-380 Bean Validation</strong> constraints (<code>@NotBlank</code>, <code>@Email</code>, <code>@Size</code>, etc.) ‚Äî Spring validates at the controller boundary before any service logic executes.</p>
          </div>
          <div class="card" style="border-top:3px solid #ea580c;">
            <h3>CustomerEntity <span style="font-weight:400; color:#94a3b8; font-size:12px;">‚Äî JPA Entity</span></h3>
            <p>The persistence object. Stores the entire <code>Customer</code> record as a single <strong>JSONB column</strong> in PostgreSQL. Decouples the relational schema from the domain model ‚Äî schema changes don't require migrations.</p>
          </div>
          <div class="tip">
            <span>üí°</span>
            <span>The service layer serializes <code>Customer ‚Üí JSON</code> on write and deserializes <code>JSON ‚Üí Customer</code> on read using Jackson's <code>ObjectMapper</code>.</span>
          </div>
        </div>
        <div>
          <div class="code-wrap">
            <div class="code-header">
              <span class="lang-label">Java</span>
              <button class="copy-btn" onclick="copyCode(this)">Copy</button>
            </div>
            <div class="code"><span class="c">// CustomerEntity ‚Äî simplified</span>
<span class="p">@Entity</span>
<span class="k">public class</span> <span class="cl">CustomerEntity</span> {

  <span class="p">@Id</span>
  <span class="p">@GeneratedValue</span>(generator = <span class="s">"tsid"</span>)
  <span class="k">private</span> <span class="cl">Long</span> id;

  <span class="p">@Column</span>(columnDefinition = <span class="s">"jsonb"</span>)
  <span class="k">private</span> <span class="cl">String</span> data; <span class="c">// ‚Üê full Customer JSON</span>

  <span class="k">private</span> <span class="cl">LocalDateTime</span> createdAt;
  <span class="k">private</span> <span class="cl">LocalDateTime</span> updatedAt;
}

<span class="c">// CustomerService ‚Äî serialize/deserialize</span>
entity.<span class="fn">setData</span>(objectMapper
  .<span class="fn">writeValueAsString</span>(customer));

<span class="cl">Customer</span> c = objectMapper.<span class="fn">readValue</span>(
  entity.<span class="fn">getData</span>(), <span class="cl">Customer</span>.<span class="k">class</span>);</div>
          </div>
        </div>
      </div>
    </div>

    <hr class="divider"/>

    <!-- ‚îÄ‚îÄ 4. TSID ‚îÄ‚îÄ -->
    <div class="section" id="tsid">
      <div class="section-header">
        <div class="section-num amber">4</div>
        <div>
          <h2>TSID ‚Äî Time-Sorted IDs</h2>
          <div class="section-sub">Distributed-safe, sortable 63-bit identifiers</div>
        </div>
      </div>

      <div class="section-body">
      <div class="two-col">
        <div class="steps">
          <div class="step">
            <div class="step-circle">1</div>
            <div class="step-body">
              <strong>63-bit structure</strong>
              <p>41 bits timestamp ¬∑ 10 bits worker node ¬∑ 12 bits sequence. Fits in a <code>Long</code>, no UUID overhead.</p>
            </div>
          </div>
          <div class="step">
            <div class="step-circle">2</div>
            <div class="step-body">
              <strong>Naturally sortable</strong>
              <p>IDs sort chronologically without a separate <code>created_at</code> index ‚Äî efficient for range queries and cursor-based pagination.</p>
            </div>
          </div>
          <div class="step">
            <div class="step-circle">3</div>
            <div class="step-body">
              <strong>Distributed-safe</strong>
              <p>Worker bits prevent collisions across instances without a central coordinator ‚Äî no database round-trip to generate an ID.</p>
            </div>
          </div>
          <div class="step">
            <div class="step-circle">4</div>
            <div class="step-body">
              <strong>Zero config via Hibernate</strong>
              <p>Integrates with Hibernate via <code>@GeneratedValue(generator = "tsid")</code> ‚Äî no custom code needed.</p>
            </div>
          </div>
        </div>
        <div>
          <div class="code-wrap">
            <div class="code-header">
              <span class="lang-label">Java</span>
              <button class="copy-btn" onclick="copyCode(this)">Copy</button>
            </div>
            <div class="code"><span class="c">// TSID bit layout</span>
<span class="c">// |&lt;--- 41 bits --->|&lt;-10->|&lt;-12->|</span>
<span class="c">// | unix ms timestamp | node | seq  |</span>

<span class="c">// Example value</span>
<span class="n">0669204195801038848L</span>
<span class="c">// ‚Üí 2024-03-15T14:22:01Z, node 0</span>

<span class="c">// vs UUID ‚Äî 128-bit, not sortable</span>
<span class="s">"550e8400-e29b-41d4-a716-446655440000"</span>

<span class="c">// vs auto-increment ‚Äî sequential but</span>
<span class="c">// not distributed-safe, reveals count</span></div>
          </div>

          <table class="data-table" style="margin-top:12px;">
            <thead><tr><th>ID Type</th><th>Sortable</th><th>Distributed</th><th>Size</th></tr></thead>
            <tbody>
              <tr><td><code>TSID</code></td><td>‚úì Yes</td><td>‚úì Yes</td><td>63-bit Long</td></tr>
              <tr><td><code>UUID v4</code></td><td>‚úó No</td><td>‚úì Yes</td><td>128-bit</td></tr>
              <tr><td><code>AUTO_INCREMENT</code></td><td>‚úì Yes</td><td>‚úó No</td><td>32/64-bit</td></tr>
            </tbody>
          </table>
        </div>
      </div>
      </div><!-- /section-body -->
    </div>

    <hr class="divider"/>

    <!-- ‚îÄ‚îÄ 5. REST API ‚îÄ‚îÄ -->
    <div class="section" id="api">
      <div class="section-header">
        <div class="section-num green">5</div>
        <div>
          <h2>REST API Layer</h2>
          <div class="section-sub">Interface/implementation split for clean OpenAPI contracts</div>
        </div>
      </div>

      <div class="two-col">
        <div>
          <div class="card" style="border-top:3px solid #2563eb; margin-bottom:12px;">
            <h3>CustomerAPI ‚Äî Interface</h3>
            <p>Owns the entire OpenAPI contract. All <code>@Operation</code>, <code>@ApiResponse</code>, and <code>@Parameter</code> annotations live here.</p>
          </div>
          <div class="card" style="border-top:3px solid #7c3aed; margin-bottom:12px;">
            <h3>CustomerController ‚Äî Implementation</h3>
            <p>Implements the interface. Contains zero documentation annotations ‚Äî only routing and delegation to <code>CustomerService</code>.</p>
          </div>
          <div class="alert alert-info">
            <span>üí°</span>
            <span><strong>Why?</strong> The interface becomes the single source of truth for the API spec. Swagger UI reads from it without cluttering the controller.</span>
          </div>
          <div class="card" style="border-top:3px solid #0d9488; margin-top:12px;">
            <h3>Keyset Pagination</h3>
            <p><code>GET /customers?limit=N&amp;after=&lt;cursor&gt;</code> ‚Äî cursor is the last-seen TSID. Scales to large datasets without <code>OFFSET</code> degradation. Returns a <code>nextCursor</code> in the response when more pages exist.</p>
          </div>
          <div class="card" style="border-top:3px solid #d97706; margin-top:12px;">
            <h3>PATCH ‚Äî JSON Merge Patch</h3>
            <p><code>PATCH /customers/{id}</code> follows RFC 7396. Only the supplied fields are merged; omitted fields are left unchanged. Consumers send a sparse JSON body ‚Äî no need to fetch and re-send the full record.</p>
          </div>
          <div class="card" style="border-top:3px solid #7c3aed; margin-top:12px;">
            <h3>Search Endpoints</h3>
            <p><code>GET /customers/search?email=</code> and <code>?ssn=</code> perform exact-match lookups using the GIN-indexed JSONB column. Returns the matching Customer or 404 if not found.</p>
          </div>
        </div>
        <div>
          <div class="code-wrap">
            <div class="code-header">
              <span class="lang-label">Java</span>
              <button class="copy-btn" onclick="copyCode(this)">Copy</button>
            </div>
            <div class="code"><span class="c">// Endpoints ‚Äî base: /api/v1/customers</span>
<span class="k">GET</span>    /api/v1/customers?limit=N&amp;after=&lt;cursor&gt; <span class="c">// keyset pagination</span>
<span class="k">GET</span>    /api/v1/customers/{id}
<span class="k">POST</span>   /api/v1/customers
<span class="k">PUT</span>    /api/v1/customers/{id}
<span class="k">PATCH</span>  /api/v1/customers/{id}              <span class="c">// RFC 7396 JSON Merge Patch</span>
<span class="k">DELETE</span> /api/v1/customers/{id}
<span class="k">GET</span>    /api/v1/customers/search?email=&lt;addr&gt;
<span class="k">GET</span>    /api/v1/customers/search?ssn=&lt;value&gt;

<span class="c">// CustomerController ‚Äî simplified</span>
<span class="p">@RestController</span>
<span class="k">public class</span> <span class="cl">CustomerController</span>
    <span class="k">implements</span> <span class="cl">CustomerAPI</span> {

  <span class="p">@Override</span>
  <span class="k">public</span> <span class="cl">ResponseEntity</span>&lt;<span class="cl">Customer</span>&gt;
      <span class="fn">getCustomer</span>(<span class="cl">Long</span> id) {
    <span class="k">return</span> <span class="cl">ResponseEntity</span>.<span class="fn">ok</span>(
      service.<span class="fn">findById</span>(id));
  }
}</div>
          </div>
        </div>
      </div>
    </div>

    <hr class="divider"/>

    <!-- ‚îÄ‚îÄ 6. Event Publishing ‚îÄ‚îÄ -->
    <div class="section" id="events">
      <div class="section-header">
        <div class="section-num rose">6</div>
        <div>
          <h2>Event Publishing</h2>
          <div class="section-sub">CloudEvents spec over Kafka, async with callbacks</div>
        </div>
      </div>

      <div class="card-grid cols-3" style="margin-bottom:16px;">
        <div class="card" style="border-top:3px solid #16a34a;">
          <h3>Customer::created</h3>
          <p>Published after a successful <code>POST /customers</code>. Carries the full Customer payload.</p>
        </div>
        <div class="card" style="border-top:3px solid #d97706;">
          <h3>Customer::updated</h3>
          <p>Published after a successful <code>PUT /customers/{id}</code> or <code>PATCH /customers/{id}</code>. Carries the updated payload.</p>
        </div>
        <div class="card" style="border-top:3px solid #e11d48;">
          <h3>Customer::deleted</h3>
          <p>Published after a successful <code>DELETE /customers/{id}</code>. Carries the customer ID.</p>
        </div>
      </div>

      <div class="code-wrap">
        <div class="code-header">
          <span class="lang-label">Java</span>
          <button class="copy-btn" onclick="copyCode(this)">Copy</button>
        </div>
        <div class="code"><span class="c">// CustomerEventPublisher ‚Äî simplified</span>
<span class="cl">CloudEvent</span> event = <span class="cl">CloudEventBuilder</span>.<span class="fn">v1</span>()
  .<span class="fn">withId</span>(<span class="cl">UUID</span>.<span class="fn">randomUUID</span>().<span class="fn">toString</span>())
  .<span class="fn">withType</span>(<span class="s">"Customer::created"</span>)
  .<span class="fn">withSource</span>(<span class="cl">URI</span>.<span class="fn">create</span>(<span class="s">"/customers"</span>))
  .<span class="fn">withTime</span>(<span class="cl">OffsetDateTime</span>.<span class="fn">now</span>())
  .<span class="fn">withData</span>(payload)
  .<span class="fn">build</span>();

kafkaTemplate.<span class="fn">send</span>(<span class="s">"customer-events"</span>, event)
  .<span class="fn">whenComplete</span>((result, ex) -&gt; {
    <span class="k">if</span> (ex != <span class="k">null</span>) log.<span class="fn">error</span>(<span class="s">"Publish failed"</span>, ex);
    <span class="k">else</span>         log.<span class="fn">info</span>(<span class="s">"Published: {}"</span>, event.<span class="fn">getId</span>());
  });</div>
      </div>
      <div class="tip" style="margin-top:10px;">
        <span>üí°</span>
        <span>All three event types share one topic (<code>customer-events</code>). Downstream consumers filter by the CloudEvent <code>type</code> attribute ‚Äî no need for separate topics per operation.</span>
      </div>
    </div>

    <hr class="divider"/>

    <!-- ‚îÄ‚îÄ 7. Error Handling ‚îÄ‚îÄ -->
    <div class="section" id="errors">
      <div class="section-header">
        <div class="section-num orange">7</div>
        <div>
          <h2>Error Handling</h2>
          <div class="section-sub">RFC 7807 Problem Details with OTel trace correlation</div>
        </div>
      </div>

      <div class="two-col">
        <div>
          <div class="card" style="margin-bottom:12px;">
            <h3>ExceptionTranslator</h3>
            <p><code>@RestControllerAdvice</code> that intercepts all exceptions and maps them to structured Problem Details responses. No try/catch in controllers or services.</p>
          </div>

          <table class="data-table">
            <thead><tr><th>Exception</th><th>HTTP Status</th></tr></thead>
            <tbody>
              <tr><td><code>CustomerNotFoundException</code></td><td>404 Not Found</td></tr>
              <tr><td><code>CustomerConflictException</code></td><td>409 Conflict</td></tr>
              <tr><td>Validation errors</td><td>400 Bad Request</td></tr>
              <tr><td><code>ServiceUnavailableException</code></td><td>503 Unavailable</td></tr>
              <tr><td>Catch-all</td><td>500 Internal Error</td></tr>
            </tbody>
          </table>

          <div class="alert alert-warn" style="margin-top:12px;">
            <span>üîó</span>
            <span>Every error response includes <code>traceId</code> and <code>spanId</code>, linking the HTTP error directly to the trace in Tempo.</span>
          </div>
        </div>
        <div>
          <div class="code-wrap">
            <div class="code-header">
              <span class="lang-label json">JSON</span>
              <button class="copy-btn" onclick="copyCode(this)">Copy</button>
            </div>
            <div class="code">{
  <span class="s">"type"</span>:     <span class="s">"about:blank"</span>,
  <span class="s">"title"</span>:    <span class="s">"Not Found"</span>,
  <span class="s">"status"</span>:   <span class="n">404</span>,
  <span class="s">"detail"</span>:   <span class="s">"Customer 42 not found"</span>,
  <span class="s">"instance"</span>: <span class="s">"/api/v1/customers/42"</span>,
  <span class="s">"traceId"</span>:  <span class="s">"4bf92f3577b34da6..."</span>,
  <span class="s">"spanId"</span>:   <span class="s">"00f067aa0ba902b7"</span>
}

<span class="c">// Exception hierarchy</span>
<span class="cl">CustomerServiceException</span>        <span class="c">// base</span>
 ‚îú‚îÄ‚îÄ <span class="cl">CustomerNotFoundException</span>   <span class="c">// 404</span>
 ‚îú‚îÄ‚îÄ <span class="cl">CustomerConflictException</span>   <span class="c">// 409</span>
 ‚îî‚îÄ‚îÄ <span class="cl">ServiceUnavailableException</span> <span class="c">// 503</span></div>
          </div>
        </div>
      </div>
    </div>

    <hr class="divider"/>

    <!-- ‚îÄ‚îÄ 8. JsonUtils ‚îÄ‚îÄ -->
    <div class="section" id="json">
      <div class="section-header">
        <div class="section-num sky">8</div>
        <div>
          <h2>JsonUtils</h2>
          <div class="section-sub">Thread-safe utility class wrapping Jackson + JSONPath</div>
        </div>
      </div>

      <div class="two-col">
        <div>
          <div class="card" style="border-top:3px solid #0284c7; margin-bottom:12px;">
            <h3>@UtilityClass (Lombok)</h3>
            <p>Private constructor and all-static methods enforced at compile time. Single shared <code>ObjectMapper</code> instance ‚Äî construction is expensive, reuse is essential.</p>
          </div>
          <div class="card" style="border-top:3px solid #7c3aed; margin-bottom:12px;">
            <h3>Dual-mode RFC validation</h3>
            <p><code>isJson(s)</code> ‚Äî RFC 7159, any root value.<br/><code>isJson(s, true)</code> ‚Äî RFC 4627 strict, root must be object/array.<br/><code>FAIL_ON_TRAILING_TOKENS</code> enabled ‚Äî rejects <code>"42 garbage"</code>.</p>
          </div>
          <div class="card" style="border-top:3px solid #16a34a;">
            <h3>Optional-based JSONPath</h3>
            <p><code>extractValue(json, "$.name")</code> returns <code>Optional&lt;T&gt;</code>. <code>PathNotFoundException</code> becomes <code>Optional.empty()</code>. Provider pinned to json-smart to avoid global state leakage.</p>
          </div>
        </div>
        <div>
          <div class="code-wrap">
            <div class="code-header">
              <span class="lang-label">Java</span>
              <button class="copy-btn" onclick="copyCode(this)">Copy</button>
            </div>
            <div class="code"><span class="c">// ObjectMapper ‚Äî static initializer</span>
objectMapper.<span class="fn">registerModule</span>(<span class="k">new</span> <span class="cl">JavaTimeModule</span>());
objectMapper.<span class="fn">disable</span>(WRITE_DATES_AS_TIMESTAMPS);
objectMapper.<span class="fn">enable</span>(FAIL_ON_TRAILING_TOKENS);

<span class="c">// Isolated JsonPath provider</span>
jsonPathConfig = <span class="cl">Configuration</span>.<span class="fn">builder</span>()
  .<span class="fn">jsonProvider</span>(<span class="k">new</span> <span class="cl">JsonSmartJsonProvider</span>())
  .<span class="fn">build</span>();

<span class="c">// Usage examples</span>
<span class="cl">Optional</span>&lt;<span class="cl">String</span>&gt; name =
  <span class="cl">JsonUtils</span>.<span class="fn">extractValue</span>(json, <span class="s">"$.firstName"</span>);

<span class="cl">Customer</span> c =
  <span class="cl">JsonUtils</span>.<span class="fn">fromJson</span>(json, <span class="cl">Customer</span>.<span class="k">class</span>);

<span class="cl">List</span>&lt;<span class="cl">Customer</span>&gt; list =
  <span class="cl">JsonUtils</span>.<span class="fn">fromJson</span>(json, <span class="k">new</span> <span class="cl">TypeReference</span>&lt;&gt;(){});</div>
          </div>
        </div>
      </div>
    </div>

    <hr class="divider"/>

    <!-- ‚îÄ‚îÄ 9. OpenTelemetry ‚îÄ‚îÄ -->
    <div class="section" id="otel">
      <div class="section-header">
        <div class="section-num slate">9</div>
        <div>
          <h2>OpenTelemetry Pipeline</h2>
          <div class="section-sub">Traces ¬∑ Metrics ¬∑ Logs ‚Äî unified via OTLP</div>
        </div>
      </div>

      <div class="pipeline">
        <div class="pipeline-row">
          <div class="pipeline-label">App</div>
          <div class="pipeline-nodes">
            <div class="pnode blue">Spring Boot Service</div>
            <div class="pnode" style="font-size:12px; color:#94a3b8;">+ OTel Java Agent (auto-instrument)</div>
          </div>
        </div>
        <div class="pipeline-down">‚Üì OTLP/HTTP :4318</div>
        <div class="pipeline-row">
          <div class="pipeline-label">Collector</div>
          <div class="pipeline-nodes">
            <div class="pnode orange">OTel Collector</div>
            <div class="pnode" style="font-size:12px; color:#94a3b8;">receives ¬∑ batches ¬∑ exports</div>
          </div>
        </div>
        <div class="pipeline-down">‚Üì fan-out to backends</div>
        <div class="pipeline-row">
          <div class="pipeline-label">Backends</div>
          <div class="pipeline-nodes">
            <div class="pnode green">Tempo ‚Äî traces</div>
            <div class="pnode amber">Prometheus ‚Äî metrics</div>
            <div class="pnode purple">Loki ‚Äî logs</div>
          </div>
        </div>
        <div class="pipeline-down">‚Üì</div>
        <div class="pipeline-row">
          <div class="pipeline-label">UI</div>
          <div class="pipeline-nodes">
            <div class="pnode orange">Grafana :3000 ‚Äî unified dashboards</div>
          </div>
        </div>
      </div>

      <div class="alert alert-success">
        <span>üîó</span>
        <span><strong>Log correlation:</strong> the log pattern includes <code>%X{trace_id}</code> and <code>%X{span_id}</code> ‚Äî each log line links directly to a Tempo trace. Error responses also embed both IDs.</span>
      </div>
    </div>

    <hr class="divider"/>

    <!-- ‚îÄ‚îÄ 10. Testing ‚îÄ‚îÄ -->
    <div class="section" id="testing">
      <div class="section-header">
        <div class="section-num blue">10</div>
        <div>
          <h2>Testing Strategy</h2>
          <div class="section-sub">Four test categories from unit to integration</div>
        </div>
      </div>

      <div class="card-grid cols-2">
        <div class="card" style="border-top:3px solid #2563eb;">
          <h3>Unit Tests</h3>
          <p>Mock-based tests for Controller, Service, EventPublisher, and ExceptionTranslator. Written with <strong>JUnit 5</strong> (<code>@ExtendWith(MockitoExtension.class)</code>), <strong>Mockito</strong> for stubbing, and <strong>AssertJ</strong> fluent assertions (<code>assertThat(...).isEqualTo(...)</code>). Fast, no I/O. <code>UnitTestConfig</code> wires mock beans.</p>
        </div>
        <div class="card" style="border-top:3px solid #7c3aed;">
          <h3>Integration Tests</h3>
          <p><code>@SpringBootTest</code> with real PostgreSQL + Kafka via Testcontainers. <code>TestOtelApplication</code> is the entry point.</p>
        </div>
        <div class="card" style="border-top:3px solid #ea580c;">
          <h3>Domain Tests</h3>
          <p>Repository-level tests against a real PostgreSQL container. Validates JSONB storage, TSID generation, and Flyway migrations in isolation.</p>
        </div>
        <div class="card" style="border-top:3px solid #16a34a;">
          <h3>Utility Tests</h3>
          <p>JsonUtils split across 5 focused test classes: File, ToJson, FromJson, ExtractValue, IsJson. <code>Faker</code> generates realistic test data.</p>
        </div>
      </div>

      <div class="code-wrap" style="margin-top:16px;">
        <div class="code-header">
          <span class="lang-label sh">Shell</span>
          <button class="copy-btn" onclick="copyCode(this)">Copy</button>
        </div>
        <div class="code"><span class="c"># Run all tests</span>
<span class="cmd">mvn test</span>

<span class="c"># Run a single test class</span>
<span class="cmd">mvn test</span> <span class="flag">-Dtest</span>=CustomerServiceUnitTest

<span class="c"># Run a single test method</span>
<span class="cmd">mvn test</span> <span class="flag">-Dtest</span>=CustomerServiceUnitTest<span class="s">#shouldCreateCustomer</span></div>
      </div>
    </div>

    <hr class="divider"/>

    <!-- ‚îÄ‚îÄ 11. Infrastructure ‚îÄ‚îÄ -->
    <div class="section" id="infra">
      <div class="section-header">
        <div class="section-num teal">11</div>
        <div>
          <h2>Infrastructure</h2>
          <div class="section-sub">Full observability stack via Docker Compose</div>
        </div>
      </div>

      <div class="card-grid cols-3" style="margin-bottom:16px;">
        <div class="card">
          <h3>PostgreSQL 15</h3>
          <p>Customer data stored in a JSONB column. Schema managed by Flyway migrations. <code>V1_1_0</code> adds <strong>GIN indexes</strong> on the JSONB column for fast email and SSN lookups without full-table scans.</p>
        </div>
        <div class="card">
          <h3>Kafka (KRaft)</h3>
          <p>No ZooKeeper. Single-node KRaft mode. Topic <code>customer-events</code> receives all CloudEvents.</p>
        </div>
        <div class="card">
          <h3>OTel Collector</h3>
          <p>OTLP receiver on :4318. Fans out to Tempo, Prometheus, and Loki.</p>
        </div>
        <div class="card">
          <h3>Tempo</h3>
          <p>Distributed trace storage. Linked from Grafana ‚Äî click a trace ID in a log to jump to the waterfall view.</p>
        </div>
        <div class="card">
          <h3>Loki</h3>
          <p>Log aggregation. Structured logs include <code>trace_id</code> for cross-signal correlation.</p>
        </div>
        <div class="card">
          <h3>Grafana :3000</h3>
          <p>Unified UI. Pre-wired datasources for Tempo, Prometheus, and Loki.</p>
        </div>
      </div>

      <div class="code-wrap">
        <div class="code-header">
          <span class="lang-label sh">Shell</span>
          <button class="copy-btn" onclick="copyCode(this)">Copy</button>
        </div>
        <div class="code"><span class="c"># Start full observability stack</span>
<span class="cmd">docker compose</span> <span class="flag">-f</span> infra/docker-compose.yml up <span class="flag">-d</span>

<span class="c"># Run app with local profile (auto-connects to docker stack)</span>
<span class="cmd">mvn spring-boot:run</span> <span class="flag">-Dspring-boot.run.profiles</span>=local

<span class="c"># Run with OTel agent explicitly</span>
<span class="cmd">java</span> <span class="flag">-javaagent</span>:opentelemetry-javaagent.jar \
     <span class="flag">-Dspring.profiles.active</span>=local \
     <span class="flag">-jar</span> target/otel-0.0.1-SNAPSHOT.jar</div>
      </div>
    </div>

    <hr class="divider"/>

    <!-- ‚îÄ‚îÄ 12. Data Flow ‚îÄ‚îÄ -->
    <div class="section" id="dataflow">
      <div class="section-header">
        <div class="section-num purple">12</div>
        <div>
          <h2>End-to-End Data Flow</h2>
          <div class="section-sub">POST /customers ‚Äî what happens step by step</div>
        </div>
      </div>

      <div class="section-body">

        <!-- Row 1: Request entry ‚Äî OTel is first -->
        <div class="flow-row" style="border:none; padding:16px 0 8px; box-shadow:none; background:transparent;">
          <div class="flow-box" style="background:#eff6ff; border-color:#bfdbfe;">
            <div class="fb-name">HTTP Request</div>
            <div class="fb-type">POST /api/v1/customers</div>
          </div>
          <div class="flow-arrow">‚Üí</div>
          <div class="flow-box" style="background:#ecfeff; border-color:#a5f3fc;">
            <div class="fb-name">OTel Java Agent</div>
            <div class="fb-type">intercepts ¬∑ starts span</div>
          </div>
          <div class="flow-arrow">‚Üí</div>
          <div class="flow-box">
            <div class="fb-name">CustomerController</div>
            <div class="fb-type">REST Layer ¬∑ validates body</div>
          </div>
        </div>

        <div style="text-align:center; font-size:16px; color:#cbd5e1; padding:2px 0;">‚Üì</div>

        <!-- Row 2: Business logic + persistence -->
        <div class="flow-row" style="border:none; padding:8px 0; box-shadow:none; background:transparent;">
          <div class="flow-box">
            <div class="fb-name">CustomerService</div>
            <div class="fb-type">Business Logic ¬∑ TSID assign</div>
          </div>
          <div class="flow-arrow">‚Üí</div>
          <div class="flow-box">
            <div class="fb-name">CustomerRepository</div>
            <div class="fb-type">Data Layer</div>
          </div>
          <div class="flow-arrow">‚Üí</div>
          <div class="flow-box" style="background:#fff1f2; border-color:#fecdd3;">
            <div class="fb-name">PostgreSQL</div>
            <div class="fb-type">JSONB column</div>
          </div>
        </div>

        <div style="text-align:center; font-size:14px; color:#cbd5e1; padding:2px 0;">‚Üì side-effect (async)</div>

        <!-- Row 3: Kafka event -->
        <div class="flow-row" style="border:none; padding:8px 0; box-shadow:none; background:transparent;">
          <div class="flow-box">
            <div class="fb-name">CustomerEventPublisher</div>
            <div class="fb-type">Kafka side-effect</div>
          </div>
          <div class="flow-arrow">‚Üí</div>
          <div class="flow-box" style="background:#fffbeb; border-color:#fde68a;">
            <div class="fb-name">customer-events</div>
            <div class="fb-type">Kafka Topic ¬∑ CloudEvent</div>
          </div>
        </div>

        <div style="text-align:center; font-size:14px; color:#cbd5e1; padding:2px 0;">‚Üì span closes ¬∑ telemetry exported</div>

        <!-- Row 4: Response + OTel pipeline -->
        <div class="flow-row" style="border:none; padding:8px 0 16px; box-shadow:none; background:transparent;">
          <div class="flow-box" style="background:#eff6ff; border-color:#bfdbfe;">
            <div class="fb-name">HTTP 201</div>
            <div class="fb-type">Response to caller</div>
          </div>
          <div class="flow-arrow">‚Üí</div>
          <div class="flow-box" style="background:#ecfeff; border-color:#a5f3fc;">
            <div class="fb-name">OTel Collector</div>
            <div class="fb-type">batches ¬∑ exports ¬∑ :4318</div>
          </div>
          <div class="flow-arrow">‚Üí</div>
          <div class="flow-box" style="background:#f0fdf4; border-color:#bbf7d0;">
            <div class="fb-name">Tempo ¬∑ Prometheus ¬∑ Loki</div>
            <div class="fb-type">traces ¬∑ metrics ¬∑ logs</div>
          </div>
          <div class="flow-arrow">‚Üí</div>
          <div class="flow-box" style="background:#fff7ed; border-color:#fed7aa;">
            <div class="fb-name">Grafana :3000</div>
            <div class="fb-type">unified dashboards</div>
          </div>
        </div>

        <div class="alert alert-success" style="margin-bottom:0;">
          <span>‚úì</span>
          <span>A single <strong>trace_id</strong> ties together the HTTP span, the DB query span, the Kafka producer span, and every log line ‚Äî visible as one correlated waterfall in Tempo.</span>
        </div>
      </div><!-- /section-body -->
    </div>

    <div class="footer">
      OTel Demo Service ¬∑ Architecture Guide ¬∑ Spring Boot 3.4.2 ¬∑ Java 21
    </div>
  </main>

</div><!-- /.layout -->

<script>
  // ‚îÄ‚îÄ Navigation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function goTo(id) {
    const el = document.getElementById(id);
    if (el) el.scrollIntoView({ behavior: 'smooth' });
    closeSidebar();
  }

  const navLinks  = document.querySelectorAll('.nav-link');
  const pills     = document.querySelectorAll('.snav-pill');
  const sectionIds = ['intro','stack','layers','domain','tsid','api','events','errors','json','otel','testing','infra','dataflow'];

  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        const id = entry.target.id;
        navLinks.forEach(l => l.classList.remove('active'));
        pills.forEach(p => p.classList.remove('active'));
        navLinks.forEach(l => { if (l.getAttribute('onclick')?.includes(`'${id}'`)) l.classList.add('active'); });
        pills.forEach(p   => { if (p.getAttribute('onclick')?.includes(`'${id}'`))  p.classList.add('active'); });
      }
    });
  }, { rootMargin: '-20% 0px -70% 0px' });

  sectionIds.forEach(id => { const el = document.getElementById(id); if (el) observer.observe(el); });

  // ‚îÄ‚îÄ Copy code ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function copyCode(btn) {
    const wrap = btn.closest('.code-wrap');
    const code = wrap.querySelector('.code');
    navigator.clipboard.writeText(code.innerText).then(() => {
      btn.textContent = 'Copied!';
      setTimeout(() => btn.textContent = 'Copy', 2000);
    });
  }

  // ‚îÄ‚îÄ Responsive sidebar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function toggleSidebar() {
    const sidebar  = document.querySelector('.sidebar');
    const overlay  = document.getElementById('sidebar-overlay');
    const isOpen   = sidebar.classList.contains('open');
    sidebar.classList.toggle('open', !isOpen);
    overlay.classList.toggle('open', !isOpen);
  }
  function closeSidebar() {
    document.querySelector('.sidebar').classList.remove('open');
    document.getElementById('sidebar-overlay').classList.remove('open');
  }

  // ‚îÄ‚îÄ Search index ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Build a searchable index from every section's headings + text content
  const searchIndex = [];
  const sectionEmoji = {
    intro:'‚òÖ', stack:'üì¶', layers:'üèó', domain:'üß©', tsid:'üîë',
    api:'üåê', events:'üì®', errors:'‚ö†Ô∏è', json:'{ }', otel:'üì°',
    testing:'üß™', infra:'üê≥', dataflow:'‚ö°'
  };

  document.addEventListener('DOMContentLoaded', () => {
    sectionIds.forEach(id => {
      const sec  = document.getElementById(id);
      if (!sec) return;
      const h2   = sec.querySelector('h2')?.textContent.trim() || id;
      const sub  = sec.querySelector('.section-sub')?.textContent.trim() || '';
      // Collect all visible text, deduplicated, excluding code blocks
      const walker = document.createTreeWalker(sec, NodeFilter.SHOW_TEXT, {
        acceptNode(node) {
          const p = node.parentElement;
          // skip code blocks and section-num/header chrome
          if (p.closest('.code, .code-header, .section-num, .nav-num, .tag-row')) return NodeFilter.FILTER_REJECT;
          return node.textContent.trim() ? NodeFilter.FILTER_ACCEPT : NodeFilter.FILTER_REJECT;
        }
      });
      let textParts = [];
      while (walker.nextNode()) textParts.push(walker.currentNode.textContent.trim());
      const fullText = textParts.join(' ').replace(/\s+/g, ' ');

      // Also index individual h3 headings as sub-entries
      sec.querySelectorAll('h3').forEach(h3 => {
        searchIndex.push({ id, title: h3.textContent.trim(), sub: h2, full: '', emoji: sectionEmoji[id] || '¬ß' });
      });

      searchIndex.push({ id, title: h2, sub, full: fullText, emoji: sectionEmoji[id] || '¬ß' });
    });
  });

  // ‚îÄ‚îÄ Search UI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  let selectedIdx = -1;

  function openSearch() {
    document.getElementById('search-overlay').classList.add('open');
    document.getElementById('search-input').focus();
    document.getElementById('search-input').value = '';
    document.getElementById('search-clear').classList.remove('visible');
    renderResults('');
    selectedIdx = -1;
  }

  function closeSearch(e) {
    if (!e || e.target === document.getElementById('search-overlay')) {
      document.getElementById('search-overlay').classList.remove('open');
    }
  }

  function clearSearch() {
    document.getElementById('search-input').value = '';
    document.getElementById('search-clear').classList.remove('visible');
    document.getElementById('search-input').focus();
    renderResults('');
    selectedIdx = -1;
  }

  function highlight(text, query) {
    if (!query) return text;
    const escaped = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    return text.replace(new RegExp(`(${escaped})`, 'gi'), '<mark>$1</mark>');
  }

  function excerpt(text, query, maxLen = 90) {
    if (!query || !text) return text.slice(0, maxLen) + (text.length > maxLen ? '‚Ä¶' : '');
    const idx = text.toLowerCase().indexOf(query.toLowerCase());
    if (idx === -1) return text.slice(0, maxLen) + (text.length > maxLen ? '‚Ä¶' : '');
    const start = Math.max(0, idx - 30);
    const end   = Math.min(text.length, idx + query.length + 60);
    return (start > 0 ? '‚Ä¶' : '') + text.slice(start, end) + (end < text.length ? '‚Ä¶' : '');
  }

  function renderResults(query) {
    const container = document.getElementById('search-results');
    const empty     = document.getElementById('search-empty');
    document.getElementById('search-query-label').textContent = query;
    selectedIdx = -1;

    if (!query.trim()) {
      // Show all sections when no query
      const html = searchIndex
        .filter(e => e.full !== '' || e.sub === e.title) // only top-level entries
        .map((e, i) => `
          <div class="sr-item" data-id="${e.id}" onclick="jumpTo('${e.id}')">
            <div class="sr-icon">${e.emoji}</div>
            <div class="sr-body">
              <div class="sr-title">${e.title}</div>
              ${e.sub && e.sub !== e.title ? `<div class="sr-sub">${e.sub}</div>` : ''}
            </div>
          </div>`).join('');
      container.innerHTML = html;
      empty.classList.remove('visible');
      return;
    }

    const q = query.toLowerCase();
    const matches = searchIndex
      .map(e => {
        const titleScore = e.title.toLowerCase().includes(q) ? 3 : 0;
        const subScore   = e.sub.toLowerCase().includes(q)   ? 2 : 0;
        const bodyScore  = e.full.toLowerCase().includes(q)  ? 1 : 0;
        const score = titleScore + subScore + bodyScore;
        return { ...e, score };
      })
      .filter(e => e.score > 0)
      .sort((a, b) => b.score - a.score)
      .slice(0, 8);

    if (!matches.length) {
      container.innerHTML = '';
      empty.classList.add('visible');
      return;
    }
    empty.classList.remove('visible');

    container.innerHTML = matches.map((e, i) => {
      const exc = e.full ? excerpt(e.full, query) : '';
      return `
        <div class="sr-item" data-id="${e.id}" onclick="jumpTo('${e.id}')">
          <div class="sr-icon">${e.emoji}</div>
          <div class="sr-body">
            <div class="sr-title">${highlight(e.title, query)}</div>
            <div class="sr-sub">${highlight(exc || e.sub, query)}</div>
          </div>
        </div>`;
    }).join('');
  }

  function jumpTo(id) {
    document.getElementById('search-overlay').classList.remove('open');
    const el = document.getElementById(id);
    if (el) setTimeout(() => el.scrollIntoView({ behavior: 'smooth' }), 80);
  }

  function onSearchInput() {
    const q = document.getElementById('search-input').value;
    document.getElementById('search-clear').classList.toggle('visible', q.length > 0);
    renderResults(q);
    selectedIdx = -1;
  }

  function onSearchKey(e) {
    const items = document.querySelectorAll('.sr-item');
    if (e.key === 'Escape')    { closeSearch(); return; }
    if (e.key === 'ArrowDown') { e.preventDefault(); moveSelection(items, 1);  return; }
    if (e.key === 'ArrowUp')   { e.preventDefault(); moveSelection(items, -1); return; }
    if (e.key === 'Enter' && selectedIdx >= 0) {
      const id = items[selectedIdx]?.dataset.id;
      if (id) jumpTo(id);
    }
  }

  function moveSelection(items, dir) {
    if (!items.length) return;
    items[selectedIdx]?.classList.remove('selected');
    selectedIdx = Math.max(0, Math.min(items.length - 1, selectedIdx + dir));
    items[selectedIdx].classList.add('selected');
    items[selectedIdx].scrollIntoView({ block: 'nearest' });
  }

  // Keyboard shortcut: Cmd+K / Ctrl+K
  document.addEventListener('keydown', e => {
    if ((e.metaKey || e.ctrlKey) && e.key === 'k') { e.preventDefault(); openSearch(); }
    if (e.key === 'Escape') closeSearch();
  });
</script>
</body>
</html>
