<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>otel-demo — OpenTelemetry Runbook</title>
  <style>
    :root {
      --bg:       #0f1117;
      --surface:  #1a1d27;
      --surface2: #22263a;
      --border:   #2e3450;
      --accent:   #7c6af7;
      --accent2:  #56cfb2;
      --warn:     #f59e0b;
      --danger:   #ef4444;
      --success:  #22c55e;
      --text:     #e2e8f0;
      --muted:    #94a3b8;
      --code-bg:  #131520;
      --code-text:#c9d1d9;
      --link:     #818cf8;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.7;
    }

    /* ── Layout ── */
    .layout { display: flex; min-height: 100vh; }
    nav {
      width: 260px;
      min-width: 260px;
      background: var(--surface);
      border-right: 1px solid var(--border);
      padding: 2rem 1rem;
      position: sticky;
      top: 0;
      height: 100vh;
      overflow-y: auto;
    }
    main { flex: 1; padding: 2.5rem 3rem; max-width: 960px; }

    /* ── Nav ── */
    .nav-logo { font-size: 1rem; font-weight: 700; color: var(--accent); margin-bottom: 1.5rem; }
    .nav-logo span { color: var(--accent2); }
    nav ul { list-style: none; }
    nav ul li { margin: 2px 0; }
    nav ul li a {
      display: block;
      padding: 5px 10px;
      color: var(--muted);
      text-decoration: none;
      font-size: 0.85rem;
      border-radius: 4px;
      transition: all .15s;
    }
    nav ul li a:hover { color: var(--text); background: var(--surface2); }
    nav .nav-section {
      font-size: 0.7rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: .08em;
      color: var(--accent);
      margin: 1.2rem 10px 0.4rem;
    }
    nav ul li.sub a { padding-left: 20px; font-size: 0.8rem; }

    /* ── Typography ── */
    h1 { font-size: 2rem; font-weight: 700; color: var(--text); margin-bottom: .5rem; }
    h2 { font-size: 1.4rem; font-weight: 700; color: var(--accent); margin: 2.5rem 0 1rem;
         padding-bottom: .4rem; border-bottom: 1px solid var(--border); }
    h3 { font-size: 1.05rem; font-weight: 600; color: var(--accent2); margin: 1.5rem 0 .6rem; }
    h4 { font-size: .9rem; font-weight: 600; color: var(--warn); margin: 1.2rem 0 .4rem; }
    p  { margin-bottom: .9rem; }
    a  { color: var(--link); }
    a:hover { text-decoration: underline; }
    ul, ol { margin: .5rem 0 .9rem 1.4rem; }
    li { margin-bottom: .3rem; }
    strong { color: var(--text); }
    .muted  { color: var(--muted); font-size: .85rem; }
    .subtitle { color: var(--muted); font-size: 1rem; margin-bottom: 2rem; }

    /* ── Code blocks ── */
    pre {
      background: var(--code-bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1.2rem 1.4rem;
      overflow-x: auto;
      margin: .8rem 0 1.2rem;
      font-size: .82rem;
      line-height: 1.65;
    }
    code { font-family: "JetBrains Mono", "Fira Code", Menlo, monospace; }
    pre code { color: var(--code-text); }
    :not(pre) > code {
      background: var(--surface2);
      color: var(--accent2);
      padding: .15em .45em;
      border-radius: 4px;
      font-size: .82em;
    }

    /* ── Callouts ── */
    .callout {
      border-left: 3px solid;
      border-radius: 0 6px 6px 0;
      padding: .9rem 1.2rem;
      margin: 1rem 0;
      font-size: .88rem;
    }
    .callout.info    { border-color: var(--accent);  background: rgba(124,106,247,.08); }
    .callout.warn    { border-color: var(--warn);    background: rgba(245,158,11,.08); }
    .callout.success { border-color: var(--success); background: rgba(34,197,94,.08); }
    .callout.danger  { border-color: var(--danger);  background: rgba(239,68,68,.08); }
    .callout .label  { font-weight: 700; text-transform: uppercase; font-size: .72rem;
                       letter-spacing: .06em; margin-bottom: .3rem; }
    .callout.info    .label { color: var(--accent); }
    .callout.warn    .label { color: var(--warn); }
    .callout.success .label { color: var(--success); }
    .callout.danger  .label { color: var(--danger); }

    /* ── Step boxes ── */
    .steps { counter-reset: step; }
    .step {
      display: flex; gap: 1.2rem;
      margin: 1.2rem 0;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem 1.2rem;
    }
    .step-num {
      counter-increment: step;
      min-width: 2rem; height: 2rem;
      background: var(--accent);
      color: #fff;
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-weight: 700; font-size: .85rem; flex-shrink: 0; margin-top: .1rem;
    }
    .step-num::before { content: counter(step); }
    .step-body { flex: 1; }
    .step-body p:last-child { margin-bottom: 0; }

    /* ── Tables ── */
    table { width: 100%; border-collapse: collapse; margin: .8rem 0 1.4rem; font-size: .85rem; }
    th { background: var(--surface2); color: var(--accent); text-align: left;
         padding: .55rem .9rem; font-size: .75rem; text-transform: uppercase;
         letter-spacing: .05em; border-bottom: 2px solid var(--border); }
    td { padding: .55rem .9rem; border-bottom: 1px solid var(--border); vertical-align: top; }
    tr:hover td { background: var(--surface); }
    .badge {
      display: inline-block; padding: .15em .55em; border-radius: 4px;
      font-size: .72rem; font-weight: 700; font-family: monospace;
    }
    .badge.get    { background: rgba(34,197,94,.15);  color: var(--success); }
    .badge.post   { background: rgba(124,106,247,.15);color: var(--accent); }
    .badge.patch  { background: rgba(245,158,11,.15); color: var(--warn); }
    .badge.put    { background: rgba(56,207,178,.15); color: var(--accent2); }
    .badge.delete { background: rgba(239,68,68,.15);  color: var(--danger); }
    .badge.s201   { background: rgba(34,197,94,.15);  color: var(--success); }
    .badge.s200   { background: rgba(34,197,94,.15);  color: var(--success); }
    .badge.s204   { background: rgba(34,197,94,.15);  color: var(--success); }
    .badge.s404   { background: rgba(245,158,11,.15); color: var(--warn); }
    .badge.s400   { background: rgba(239,68,68,.15);  color: var(--danger); }
    .badge.s409   { background: rgba(239,68,68,.15);  color: var(--danger); }

    /* ── Pill tags ── */
    .tag {
      display: inline-block; font-size: .72rem; padding: .1em .6em;
      border-radius: 20px; margin: .1em;
    }
    .tag.trace   { background: rgba(124,106,247,.2); color: var(--accent); }
    .tag.metric  { background: rgba(56,207,178,.2);  color: var(--accent2); }
    .tag.log     { background: rgba(245,158,11,.2);  color: var(--warn); }

    /* ── Service port grid ── */
    .port-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: .7rem;
      margin: 1rem 0 1.5rem;
    }
    .port-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: .8rem 1rem;
    }
    .port-card .svc-name { font-weight: 700; font-size: .9rem; color: var(--accent2); }
    .port-card .svc-port { font-family: monospace; color: var(--accent); font-size: .85rem; }
    .port-card .svc-desc { color: var(--muted); font-size: .78rem; margin-top: .2rem; }

    /* ── Diagram ── */
    .diagram {
      background: var(--code-bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1.2rem 1.5rem;
      font-family: "JetBrains Mono","Fira Code",monospace;
      font-size: .78rem;
      color: var(--code-text);
      white-space: pre;
      overflow-x: auto;
      margin: 1rem 0 1.5rem;
      line-height: 1.5;
    }

    /* ── Section separator ── */
    hr { border: none; border-top: 1px solid var(--border); margin: 2rem 0; }
    .anchor { scroll-margin-top: 1.5rem; }

    /* ── TOC active highlight ── */
    @media (max-width: 768px) {
      nav { display: none; }
      main { padding: 1.5rem; }
    }
  </style>
</head>
<body>
<div class="layout">

<!-- ═══════════════════ SIDEBAR NAV ═══════════════════ -->
<nav>
  <div class="nav-logo">otel<span>-demo</span></div>

  <div class="nav-section">Overview</div>
  <ul>
    <li><a href="#architecture">Architecture</a></li>
    <li><a href="#signal-flow">Signal Flow</a></li>
    <li><a href="#services">Services &amp; Ports</a></li>
  </ul>

  <div class="nav-section">Running the Stack</div>
  <ul>
    <li><a href="#prereqs">Prerequisites</a></li>
    <li><a href="#start-infra">1 — Start Infra</a></li>
    <li><a href="#start-app">2 — Start App</a></li>
    <li><a href="#verify-signals">3 — Verify Signals</a></li>
  </ul>

  <div class="nav-section">API Reference</div>
  <ul>
    <li><a href="#api-endpoints">All Endpoints</a></li>
    <li><a href="#api-create">Create Customer</a></li>
    <li><a href="#api-get">Get by ID</a></li>
    <li><a href="#api-list">List (Paginated)</a></li>
    <li><a href="#api-patch">Partial Update</a></li>
    <li><a href="#api-put">Full Replace</a></li>
    <li><a href="#api-search">Search</a></li>
    <li><a href="#api-delete">Delete</a></li>
    <li><a href="#api-errors">Error Responses</a></li>
  </ul>

  <div class="nav-section">Load &amp; E2E Testing</div>
  <ul>
    <li><a href="#load-test">Load Test Script</a></li>
    <li><a href="#e2e-test">E2E Lifecycle Test</a></li>
    <li><a href="#manual-curl">Manual curl Examples</a></li>
  </ul>

  <div class="nav-section">Grafana Observability</div>
  <ul>
    <li><a href="#grafana-dashboards">Dashboards</a></li>
    <li><a href="#grafana-explore-traces">Explore — Traces</a></li>
    <li><a href="#grafana-explore-logs">Explore — Logs</a></li>
    <li><a href="#grafana-explore-metrics">Explore — Metrics</a></li>
    <li><a href="#trace-log-correlation">Trace → Log Correlation</a></li>
  </ul>

  <div class="nav-section">Troubleshooting</div>
  <ul>
    <li><a href="#ts-no-traces">No Traces</a></li>
    <li><a href="#ts-no-metrics">No Metrics</a></li>
    <li><a href="#ts-no-logs">No Logs</a></li>
    <li><a href="#ts-dashboards-empty">Empty Dashboards</a></li>
    <li><a href="#ts-tempo">Tempo Issues</a></li>
  </ul>

  <div class="nav-section">Reference</div>
  <ul>
    <li><a href="#otel-config">OTel Config</a></li>
    <li><a href="#metric-names">Metric Names</a></li>
    <li><a href="#key-files">Key Files</a></li>
  </ul>
</nav>

<!-- ═══════════════════ MAIN CONTENT ═══════════════════ -->
<main>

  <h1>otel-demo OpenTelemetry Runbook</h1>
  <p class="subtitle">
    Step-by-step guide for running, testing, and observing the
    <strong>otel-demo</strong> Spring Boot application with full
    OpenTelemetry instrumentation — traces, metrics, and logs.
  </p>

  <!-- ════════════════════════════════════════════════════════ -->
  <h2 id="architecture" class="anchor">Architecture</h2>

  <p>
    <strong>otel-demo</strong> is a layered Spring Boot 3.5 microservice for customer CRUD
    operations. Every HTTP request produces correlated traces, metrics, and structured logs
    exported through the OpenTelemetry Java agent to the full LGTM stack.
  </p>

  <div class="diagram">
┌─────────────────────────────── Spring Boot App (port 8080) ────────────────────────────────┐
│                                                                                              │
│   HTTP Client ──► CustomerController ──► CustomerService ──► CustomerRepository ──► Postgres│
│                          │                      │                                            │
│                          │              CustomerEventPublisher ──► Kafka (customer-events)   │
│                          │                                                                   │
│   OTel Java Agent (auto-instrumentation):                                                    │
│     Spans  → HTTP server span, Spring Data span, JDBC span, Kafka producer span             │
│     Metrics→ http.server.request.duration, jvm.memory, db.client.connections, kafka.*       │
│     Logs   → Logback with trace_id / span_id in MDC → OTLP log exporter                    │
└──────────────────────────────────────────┬───────────────────────────────────────────────────┘
                                           │ OTLP HTTP (port 4318)
                              ┌────────────▼────────────┐
                              │   OTel Collector         │
                              │  (otel-collector-contrib)│
                              │                          │
                              │  Receivers: otlp         │
                              │  Processors: batch,      │
                              │             memory_limiter│
                              │  Exporters:              │
                              │    traces  → Tempo :4317 │
                              │    metrics → Prometheus  │
                              │    logs    → Loki        │
                              └──┬──────────┬──────────┬─┘
                                 │          │          │
                    ┌────────────▼┐  ┌──────▼───┐ ┌───▼────┐
                    │   Tempo      │  │Prometheus│ │  Loki  │
                    │  (traces)    │  │(metrics) │ │ (logs) │
                    │  port 3200   │  │port 9090 │ │port3100│
                    └──────┬───────┘  └────┬─────┘ └───┬────┘
                           │               │            │
                    ┌──────▼───────────────▼────────────▼────┐
                    │              Grafana  :3000              │
                    │  Dashboards, Explore, Trace→Log links    │
                    └──────────────────────────────────────────┘
  </div>

  <!-- ════════════════════════════════════════════════════════ -->
  <h2 id="signal-flow" class="anchor">Signal Flow</h2>

  <table>
    <thead><tr><th>Signal</th><th>Producer</th><th>Transport</th><th>Collector Export</th><th>Storage</th><th>UI</th></tr></thead>
    <tbody>
      <tr>
        <td><span class="tag trace">Traces</span></td>
        <td>OTel Java Agent (bytecode instrumentation)</td>
        <td>OTLP/HTTP → <code>:4318</code></td>
        <td>OTLP/gRPC → Tempo <code>:4317</code></td>
        <td>Tempo <code>:3200</code></td>
        <td>Grafana → Explore → Tempo</td>
      </tr>
      <tr>
        <td><span class="tag metric">Metrics</span></td>
        <td>OTel Java Agent (OTLP push)</td>
        <td>OTLP/HTTP → <code>:4318</code></td>
        <td>Prometheus exposition <code>:8889</code></td>
        <td>Prometheus <code>:9090</code></td>
        <td>Grafana Dashboards + Explore → Prometheus</td>
      </tr>
      <tr>
        <td><span class="tag log">Logs</span></td>
        <td>Logback + OTel appender (trace_id/span_id in MDC)</td>
        <td>OTLP/HTTP → <code>:4318</code></td>
        <td>OTLP/HTTP → Loki <code>:3100</code></td>
        <td>Loki <code>:3100</code></td>
        <td>Grafana → Explore → Loki</td>
      </tr>
    </tbody>
  </table>

  <!-- ════════════════════════════════════════════════════════ -->
  <h2 id="services" class="anchor">Services &amp; Ports</h2>

  <div class="port-grid">
    <div class="port-card">
      <div class="svc-name">Spring Boot App</div>
      <div class="svc-port">:8080</div>
      <div class="svc-desc">Customer API + Actuator</div>
    </div>
    <div class="port-card">
      <div class="svc-name">Grafana</div>
      <div class="svc-port">:3000</div>
      <div class="svc-desc">Dashboards &amp; Explore (no auth)</div>
    </div>
    <div class="port-card">
      <div class="svc-name">Prometheus</div>
      <div class="svc-port">:9090</div>
      <div class="svc-desc">Metrics query UI</div>
    </div>
    <div class="port-card">
      <div class="svc-name">Tempo</div>
      <div class="svc-port">:3200</div>
      <div class="svc-desc">Trace storage &amp; query</div>
    </div>
    <div class="port-card">
      <div class="svc-name">Loki</div>
      <div class="svc-port">:3100</div>
      <div class="svc-desc">Log aggregation &amp; query</div>
    </div>
    <div class="port-card">
      <div class="svc-name">OTel Collector</div>
      <div class="svc-port">:4317 / :4318 / :8889</div>
      <div class="svc-desc">gRPC / HTTP receive; Prometheus export</div>
    </div>
    <div class="port-card">
      <div class="svc-name">PostgreSQL</div>
      <div class="svc-port">:5432</div>
      <div class="svc-desc">demodb / demouser / demopass</div>
    </div>
    <div class="port-card">
      <div class="svc-name">Kafka</div>
      <div class="svc-port">:9092</div>
      <div class="svc-desc">customer-events topic (KRaft)</div>
    </div>
    <div class="port-card">
      <div class="svc-name">Collector zPages</div>
      <div class="svc-port">:55679</div>
      <div class="svc-desc"><code>/debug/tracez</code> — live span debug</div>
    </div>
  </div>

  <hr />

  <!-- ════════════════════════════════════════════════════════ -->
  <h2 id="prereqs" class="anchor">Prerequisites</h2>

  <table>
    <thead><tr><th>Tool</th><th>Version</th><th>Notes</th></tr></thead>
    <tbody>
      <tr><td>Java</td><td>21 (LTS)</td><td>Install: <code>brew install --cask temurin@21</code></td></tr>
      <tr><td>Maven</td><td>3.9+</td><td>Use system <code>mvn</code> — <code>./mvnw</code> is broken</td></tr>
      <tr><td>Podman (or Docker)</td><td>Podman 5+ / Docker 24+</td><td>Podman: <code>brew install podman</code>, then <code>podman machine start</code></td></tr>
      <tr><td>podman-compose</td><td>latest</td><td><code>brew install podman-compose</code></td></tr>
      <tr><td>OTel Java Agent</td><td>2.x</td><td>Must be at <code>./opentelemetry-javaagent.jar</code> (project root)</td></tr>
      <tr><td>curl + python3</td><td>any</td><td>Used by test scripts; pre-installed on macOS</td></tr>
    </tbody>
  </table>

  <h3>Download the OTel Agent</h3>
  <pre><code>curl -L -o opentelemetry-javaagent.jar \
  https://github.com/open-telemetry/opentelemetry-java-instrumentation/releases/latest/download/opentelemetry-javaagent.jar</code></pre>

  <h3>Verify Java 21</h3>
  <pre><code># Confirm Java 21 is installed
/usr/libexec/java_home -v 21
# Should print something like: /Library/Java/JavaVirtualMachines/temurin-21.jdk/Contents/Home

# Check version
$(/usr/libexec/java_home -v 21)/bin/java -version</code></pre>

  <h3>Start Podman Machine (if using Podman)</h3>
  <pre><code>podman machine start
podman machine inspect --format '{{.ConnectionInfo.PodmanSocket.Path}}'
# Should print the socket path, e.g. /var/folders/.../podman.sock</code></pre>

  <hr />

  <!-- ════════════════════════════════════════════════════════ -->
  <h2 id="start-infra" class="anchor">1 — Start the Observability Infrastructure</h2>

  <h3>Option A — Automated script (recommended)</h3>
  <pre><code>./infra/start.sh</code></pre>
  <p>The script auto-detects Docker or Podman, starts all containers, and waits for each service to become healthy before printing the URL summary.</p>

  <h3>Option B — Manual podman compose</h3>
  <pre><code># Detect Podman socket and export
PODMAN_SOCK=$(podman machine inspect --format '{{.ConnectionInfo.PodmanSocket.Path}}')
export DOCKER_HOST="unix://$PODMAN_SOCK"
export TESTCONTAINERS_RYUK_DISABLED=true

# Start all services in the background
podman compose -f infra/docker-compose.yml up -d

# Check container status
podman ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"</code></pre>

  <h3>Verify infra health</h3>
  <pre><code># Prometheus
curl http://localhost:9090/-/ready
# → Prometheus Server is Ready.

# Grafana
curl http://localhost:3000/api/health
# → {"database":"ok","version":"11.4.0",...}

# Tempo
curl http://localhost:3200/ready
# → Ingester is ready (may take ~20s to initialise)

# OTel Collector zPages
open http://localhost:55679/debug/tracez</code></pre>

  <div class="callout warn">
    <div class="label">Tempo startup</div>
    Tempo's ingester ring takes ~15–20 seconds after container start before <code>/ready</code> returns HTTP 200.
    This is normal — the app can start sending spans immediately; Tempo will buffer them.
  </div>

  <h3>Stop the stack</h3>
  <pre><code># Stop, keep volumes (data persists between runs)
./infra/stop.sh

# Stop AND destroy all data (fresh start next time)
./infra/stop.sh --destroy</code></pre>

  <hr />

  <!-- ════════════════════════════════════════════════════════ -->
  <h2 id="start-app" class="anchor">2 — Start the Application</h2>

  <h3>Option A — Automated script</h3>
  <pre><code>./infra/start-app.sh</code></pre>
  <p>
    Builds the JAR (skipping tests), detects Java 21, starts the app with the OTel agent,
    and waits for <code>/actuator/health</code> to return UP before printing endpoint URLs.
    Set <code>SKIP_BUILD=true</code> to reuse an existing JAR.
  </p>
  <pre><code># Reuse existing JAR (faster iteration)
SKIP_BUILD=true ./infra/start-app.sh</code></pre>

  <h3>Option B — Manual</h3>
  <pre><code># 1. Build (Java 21 required)
JAVA_HOME=$(/usr/libexec/java_home -v 21) mvn clean package -DskipTests

# 2. Start with OTel agent (background)
$(/usr/libexec/java_home -v 21)/bin/java \
  -javaagent:opentelemetry-javaagent.jar \
  -Dspring.profiles.active=local \
  -Dotel.service.name=otel-demo \
  -Dotel.exporter.otlp.endpoint=http://localhost:4318 \
  -Dotel.exporter.otlp.protocol=http/protobuf \
  -Dotel.traces.sampler=always_on \
  -Dotel.metrics.exporter=otlp \
  -Dotel.logs.exporter=otlp \
  -jar target/otel-*-SNAPSHOT.jar \
  > app.log 2>&1 &

# 3. Tail the log
tail -f app.log | grep -E "Started|ERROR|WARN|trace_id"

# 4. Health check
curl http://localhost:8080/actuator/health</code></pre>

  <div class="callout info">
    <div class="label">Why explicit Java 21 path?</div>
    <code>JAVA_HOME=... java</code> sets the variable but the shell resolves <code>java</code>
    from <code>PATH</code> — which may still be Java 25 on modern Macs. Using
    <code>$(/usr/libexec/java_home -v 21)/bin/java</code> guarantees the right binary.
  </div>

  <div class="callout danger">
    <div class="label">Critical: do not set default-enabled=false</div>
    Never add <code>otel.instrumentation.common.default-enabled: false</code> to
    <code>application-local.yml</code>. Spring's OTel autoconfigure reads this property
    and disables all bytecode instrumentation — resulting in empty <code>trace_id=</code>
    in MDC and no spans exported. The <code>local</code> profile is correctly configured
    without this property.
  </div>

  <hr />

  <!-- ════════════════════════════════════════════════════════ -->
  <h2 id="verify-signals" class="anchor">3 — Verify All Three Signals</h2>

  <h3>Make a test request first</h3>
  <pre><code>curl -s -X POST http://localhost:8080/api/v1/customers \
  -H "Content-Type: application/json" \
  -d '{
    "type":"INDIVIDUAL",
    "firstName":"Test","lastName":"User",
    "emails":[{"primary":true,"email":"test@verify.com","type":"PERSONAL"}],
    "phones":[{"type":"MOBILE","countryCode":"+1","number":"5550001111"}],
    "addresses":[{"type":"HOME","line1":"1 Main St","city":"Chicago","state":"IL","postalCode":"60601","country":"USA"}]
  }' | python3 -m json.tool</code></pre>

  <h3>Verify traces in Tempo</h3>
  <pre><code># List service names known to Tempo
curl -s http://localhost:3200/api/search/tag/service.name/values | python3 -m json.tool
# → {"tagValues":["otel-demo","tempo-all"]}

# Search recent traces
curl -s "http://localhost:3200/api/search?tags=service.name%3Dotel-demo&limit=5" \
  | python3 -m json.tool</code></pre>

  <h3>Verify metrics in Prometheus</h3>
  <pre><code># Confirm HTTP request counter exists
curl -s 'http://localhost:9090/api/v1/query?query=otel_http_server_request_duration_seconds_count' \
  | python3 -c "import sys,json; r=json.load(sys.stdin); print(f'{len(r[\"data\"][\"result\"])} time series found')"

# Check available exported labels
curl -s 'http://localhost:9090/api/v1/labels' | python3 -m json.tool | grep http</code></pre>

  <h3>Verify logs in Loki</h3>
  <pre><code># Query last 5 minutes of otel-demo logs
curl -sG http://localhost:3100/loki/api/v1/query_range \
  --data-urlencode 'query={service_name="otel-demo"}' \
  --data-urlencode 'limit=10' \
  --data-urlencode 'start='$(date -v-5M +%s%N 2>/dev/null || date -d '-5 minutes' +%s%N)''\
  | python3 -c "
import sys,json
d=json.load(sys.stdin)
streams=d.get('data',{}).get('result',[])
print(f'{len(streams)} log stream(s) found')
for s in streams[:3]:
    vals=s.get('values',[])
    if vals: print(' ', vals[-1][1][:120])
"</code></pre>

  <div class="callout success">
    <div class="label">Expected outcome</div>
    <ul>
      <li>Tempo: <code>otel-demo</code> appears in service list; traces visible in search</li>
      <li>Prometheus: <code>otel_http_server_request_duration_seconds_count</code> has results with <code>exported_job="otel-demo"</code></li>
      <li>Loki: log stream with <code>trace_id</code> and <code>span_id</code> fields populated (non-empty)</li>
    </ul>
  </div>

  <hr />

  <!-- ════════════════════════════════════════════════════════ -->
  <h2 id="api-endpoints" class="anchor">API Endpoints Reference</h2>

  <p>Base path: <code>http://localhost:8080/api/v1/customers</code></p>

  <table>
    <thead>
      <tr><th>Method</th><th>Path</th><th>Description</th><th>Status</th></tr>
    </thead>
    <tbody>
      <tr>
        <td><span class="badge post">POST</span></td>
        <td><code>/customers</code></td>
        <td>Create a new customer</td>
        <td><span class="badge s201">201</span></td>
      </tr>
      <tr>
        <td><span class="badge get">GET</span></td>
        <td><code>/customers/{id}</code></td>
        <td>Fetch customer by TSID</td>
        <td><span class="badge s200">200</span> / <span class="badge s404">404</span></td>
      </tr>
      <tr>
        <td><span class="badge get">GET</span></td>
        <td><code>/customers?limit=N&amp;after=cursor</code></td>
        <td>Keyset-paginated list (default limit 20)</td>
        <td><span class="badge s200">200</span></td>
      </tr>
      <tr>
        <td><span class="badge patch">PATCH</span></td>
        <td><code>/customers/{id}</code></td>
        <td>Partial update (RFC 7396 JSON Merge Patch)</td>
        <td><span class="badge s200">200</span> / <span class="badge s404">404</span></td>
      </tr>
      <tr>
        <td><span class="badge put">PUT</span></td>
        <td><code>/customers/{id}</code></td>
        <td>Full replace — all fields required</td>
        <td><span class="badge s200">200</span> / <span class="badge s404">404</span></td>
      </tr>
      <tr>
        <td><span class="badge get">GET</span></td>
        <td><code>/customers/search?email=</code></td>
        <td>Find customer by email address</td>
        <td><span class="badge s200">200</span> / <span class="badge s404">404</span></td>
      </tr>
      <tr>
        <td><span class="badge get">GET</span></td>
        <td><code>/customers/search?ssn=</code></td>
        <td>Find customer by SSN (document lookup)</td>
        <td><span class="badge s200">200</span> / <span class="badge s404">404</span></td>
      </tr>
      <tr>
        <td><span class="badge delete">DELETE</span></td>
        <td><code>/customers/{id}</code></td>
        <td>Delete customer — publishes CloudEvent</td>
        <td><span class="badge s204">204</span> / <span class="badge s404">404</span></td>
      </tr>
    </tbody>
  </table>

  <!-- ── CREATE ── -->
  <h2 id="api-create" class="anchor">Create Customer</h2>
  <pre><code>POST /api/v1/customers
Content-Type: application/json

{
  "type": "INDIVIDUAL",
  "firstName": "Jane",
  "lastName":  "Smith",
  "middleName": "Marie",
  "suffix": "Jr",
  "emails": [
    {"primary": true, "email": "jane.smith@example.com", "type": "PERSONAL"}
  ],
  "phones": [
    {"type": "MOBILE", "countryCode": "+1", "number": "5551234567"}
  ],
  "addresses": [
    {
      "type": "HOME",
      "line1": "123 Elm Street",
      "line2": "Apt 4B",
      "city": "Chicago",
      "state": "IL",
      "postalCode": "60601",
      "country": "USA"
    }
  ],
  "documents": [
    {"type": "SSN", "value": "123-45-6789"}
  ]
}</code></pre>

  <p><strong>Response 201</strong> — full customer object with generated <code>id</code> (TSID), <code>createdAt</code>, and <code>updatedAt</code>.</p>
  <p><strong>Validation rules:</strong> <code>emails</code>, <code>phones</code>, and <code>addresses</code> must each have at least one entry (<code>@NotEmpty</code>). Duplicate email/SSN returns <span class="badge s409">409 Conflict</span>.</p>

  <!-- ── GET ── -->
  <h2 id="api-get" class="anchor">Get Customer by ID</h2>
  <pre><code>GET /api/v1/customers/814948546554233853

# Response 200
{
  "id": 814948546554233853,
  "type": "INDIVIDUAL",
  "firstName": "Jane",
  "lastName": "Smith",
  ...
  "createdAt": "2026-02-26T19:54:34.510778Z",
  "updatedAt": "2026-02-26T19:54:34.510778Z"
}</code></pre>

  <!-- ── LIST ── -->
  <h2 id="api-list" class="anchor">List Customers (Keyset Pagination)</h2>
  <pre><code># First page (most recently created first)
GET /api/v1/customers?limit=10

# Next page — pass the id of the last record as cursor
GET /api/v1/customers?limit=10&amp;after=814948546554233853</code></pre>

  <p>
    Pagination uses keyset (cursor) style — there is no <code>offset</code> or <code>page</code>
    parameter. The <code>after</code> value is the numeric TSID of the last record on the current
    page. When the response contains fewer items than <code>limit</code>, you have reached the end.
  </p>

  <!-- ── PATCH ── -->
  <h2 id="api-patch" class="anchor">Partial Update (PATCH)</h2>
  <pre><code>PATCH /api/v1/customers/814948546554233853
Content-Type: application/merge-patch+json

{"firstName": "Janet"}

# Response 200 — full updated customer
# Only firstName changes; all other fields are preserved</code></pre>

  <div class="callout info">
    <div class="label">RFC 7396 JSON Merge Patch</div>
    Send only the fields you want to change. Fields not present in the patch body are left
    unchanged. To clear an optional field, send it explicitly as <code>null</code>.
    Required fields (<code>emails</code>, <code>phones</code>, <code>addresses</code>) cannot be
    set to empty — that would fail validation on the next full read.
  </div>

  <!-- ── PUT ── -->
  <h2 id="api-put" class="anchor">Full Replace (PUT)</h2>
  <pre><code>PUT /api/v1/customers/814948546554233853
Content-Type: application/json

{
  "id": 814948546554233853,
  "type": "INDIVIDUAL",
  "firstName": "Janet",
  "lastName":  "Smith",
  "emails":    [{"primary": true, "email": "janet@example.com", "type": "PERSONAL"}],
  "phones":    [{"type": "MOBILE", "countryCode": "+1", "number": "5557654321"}],
  "addresses": [{"type": "HOME", "line1": "456 Oak Ave", "city": "Austin", "state": "TX", "postalCode": "78701", "country": "USA"}],
  "createdAt": "2026-02-26T19:54:34.510778Z"
}

# Response 200 — full replaced customer</code></pre>

  <p>
    PUT replaces the entire document. Include <code>id</code> and <code>createdAt</code> to
    preserve them. Any field not present will be set to <code>null</code>. A CloudEvent of type
    <code>Customer::updated</code> is published to Kafka.
  </p>

  <!-- ── SEARCH ── -->
  <h2 id="api-search" class="anchor">Search by Email or SSN</h2>
  <pre><code># Search by email
GET /api/v1/customers/search?email=jane.smith@example.com

# Search by SSN
GET /api/v1/customers/search?ssn=123-45-6789

# Response 200 — single customer object
# Response 404 — if not found (RFC 7807 Problem Details)</code></pre>

  <!-- ── DELETE ── -->
  <h2 id="api-delete" class="anchor">Delete Customer</h2>
  <pre><code>DELETE /api/v1/customers/814948546554233853

# Response 204 No Content
# A CloudEvent of type Customer::deleted is published to Kafka</code></pre>

  <!-- ── ERRORS ── -->
  <h2 id="api-errors" class="anchor">Error Responses (RFC 7807)</h2>
  <p>All errors follow Problem Details format with OTel <code>traceId</code> / <code>spanId</code> injected:</p>
  <pre><code>{
  "type":     "https://api.otel-demo/errors/customer-not-found",
  "title":    "Customer Not Found",
  "status":   404,
  "detail":   "Customer with id 9999999999 not found",
  "instance": "/api/v1/customers/9999999999",
  "traceId":  "4bf92f3577b34da6a3ce929d0e0e4736",
  "spanId":   "00f067aa0ba902b7"
}</code></pre>

  <table>
    <thead><tr><th>Status</th><th>Condition</th></tr></thead>
    <tbody>
      <tr><td><span class="badge s400">400</span></td><td>Bean Validation failure (missing required fields)</td></tr>
      <tr><td><span class="badge s404">404</span></td><td>Customer not found by ID, email, or SSN</td></tr>
      <tr><td><span class="badge s409">409</span></td><td>Duplicate email or SSN on create</td></tr>
      <tr><td>415</td><td>Wrong <code>Content-Type</code> (PATCH requires <code>application/merge-patch+json</code>)</td></tr>
      <tr><td>500</td><td>Internal error (DB down, serialization failure)</td></tr>
    </tbody>
  </table>

  <hr />

  <!-- ════════════════════════════════════════════════════════ -->
  <h2 id="load-test" class="anchor">Load Test Script</h2>

  <p>
    <code>infra/load-test.sh</code> generates sustained traffic across every endpoint,
    including intentional 404s to populate the error-rate panel in Grafana.
  </p>

  <pre><code># Default: 5 rounds
./infra/load-test.sh

# Custom rounds and slower pace (more visible in Grafana time-series)
ROUNDS=20 PAUSE=1.0 ./infra/load-test.sh

# Point at a different host
BASE_URL=http://staging.example.com/api/v1/customers ROUNDS=10 ./infra/load-test.sh</code></pre>

  <p><strong>Each round exercises:</strong></p>
  <ul>
    <li><code>POST</code> — create a new customer with random name/city</li>
    <li><code>GET /{id}</code> — fetch the created customer</li>
    <li><code>GET ?limit=5</code> — paginated list (first page)</li>
    <li><code>PATCH /{id}</code> — partial update of <code>firstName</code></li>
    <li><code>GET /search?email=</code> — search by the created email</li>
    <li><code>PUT /{id}</code> — full replace</li>
    <li><code>GET ?limit=5&amp;after=cursor</code> — second page (when ≥2 customers exist)</li>
    <li><code>GET /9999999999</code> × 2 — intentional 404s for error rate</li>
    <li><code>DELETE /{id}</code> — cleanup at end</li>
  </ul>

  <div class="callout info">
    <div class="label">Tip</div>
    Run with <code>ROUNDS=20 PAUSE=1.5</code> to get ~5 minutes of traffic — enough to see
    meaningful time-series shapes in the Grafana latency and request-rate panels.
  </div>

  <hr />

  <!-- ════════════════════════════════════════════════════════ -->
  <h2 id="e2e-test" class="anchor">End-to-End Customer Lifecycle Test</h2>

  <p>
    <code>infra/e2e-test.sh</code> runs a complete customer lifecycle in order,
    asserting HTTP status codes and JSON field values at every step.
    Exits 0 on full pass, 1 on any assertion failure.
  </p>

  <pre><code>./infra/e2e-test.sh</code></pre>

  <div class="steps">
    <div class="step"><div class="step-num"></div><div class="step-body">
      <strong>POST /customers</strong> — Create with full payload (email, phone, address, SSN document).
      Asserts 201, non-empty <code>id</code>, and <code>createdAt</code>.
    </div></div>
    <div class="step"><div class="step-num"></div><div class="step-body">
      <strong>GET /customers/{id}</strong> — Verify all fields persisted correctly: firstName, lastName,
      middleName, email, phone number, and city.
    </div></div>
    <div class="step"><div class="step-num"></div><div class="step-body">
      <strong>GET /customers?limit=20</strong> — Confirms the new customer appears in the paginated list.
    </div></div>
    <div class="step"><div class="step-num"></div><div class="step-body">
      <strong>PATCH /customers/{id}</strong> — Partial update of <code>firstName</code>.
      Asserts the field changed, <code>lastName</code> is unchanged, and <code>updatedAt</code>
      advanced beyond <code>createdAt</code>.
    </div></div>
    <div class="step"><div class="step-num"></div><div class="step-body">
      <strong>GET /customers/{id}</strong> — Re-fetch after PATCH. Confirms the patched value persisted.
    </div></div>
    <div class="step"><div class="step-num"></div><div class="step-body">
      <strong>PUT /customers/{id}</strong> — Full replace with different name, city, phone, and email type.
      Asserts all replaced fields, and that omitted optional fields are cleared.
    </div></div>
    <div class="step"><div class="step-num"></div><div class="step-body">
      <strong>GET /customers/{id}</strong> — Re-fetch after PUT. Confirms full replacement persisted
      and <code>middleName</code> was cleared.
    </div></div>
    <div class="step"><div class="step-num"></div><div class="step-body">
      <strong>GET /customers/search?email=</strong> — Confirms the customer is findable by email
      and returns the correct record.
    </div></div>
    <div class="step"><div class="step-num"></div><div class="step-body">
      <strong>DELETE /customers/{id}</strong> — Asserts 204 No Content.
    </div></div>
    <div class="step"><div class="step-num"></div><div class="step-body">
      <strong>GET /customers/{id}</strong> — Confirms 404 after delete and that the response
      is RFC 7807 Problem Details format.
    </div></div>
    <div class="step"><div class="step-num"></div><div class="step-body">
      <strong>GET /customers/search?email=</strong> — Confirms 404 on search after delete
      (no stale index entries).
    </div></div>
  </div>

  <h3>Sample output</h3>
  <pre><code>════════════════════════════════════════════════════
  otel-demo End-to-End Customer Lifecycle Test
════════════════════════════════════════════════════
  Target: http://localhost:8080/api/v1/customers

Step 1: POST /customers — create
  ✓  HTTP status: '201'
  ✓  id assigned: '814953710350631920'
  ✓  createdAt set: '2026-02-26T20:25:44.123456Z'
     ID:        814953710350631920
     createdAt: 2026-02-26T20:25:44.123456Z

Step 2: GET /customers/814953710350631920 — verify creation
  ✓  HTTP status: '200'
  ✓  firstName: 'E2E'
  ...

Step 9: DELETE /customers/814953710350631920
  ✓  HTTP status: '204'

Step 10: GET /customers/814953710350631920 — expect 404 after delete
  ✓  HTTP status: '404'
  ✓  RFC 7807 type: 'https://api.otel-demo/errors/customer-not-found'

════════════════════════════════════════════════════
  E2E Test Results
════════════════════════════════════════════════════
  Passed:  28 / 28
  Failed:  0 / 28

  ALL ASSERTIONS PASSED</code></pre>

  <hr />

  <!-- ════════════════════════════════════════════════════════ -->
  <h2 id="manual-curl" class="anchor">Manual curl Examples</h2>

  <h3>Create and capture ID in one line</h3>
  <pre><code>ID=$(curl -s -X POST http://localhost:8080/api/v1/customers \
  -H "Content-Type: application/json" \
  -d '{
    "type":"INDIVIDUAL","firstName":"Manual","lastName":"Test",
    "emails":[{"primary":true,"email":"manual@test.com","type":"PERSONAL"}],
    "phones":[{"type":"MOBILE","countryCode":"+1","number":"5550009999"}],
    "addresses":[{"type":"HOME","line1":"1 St","city":"Chicago","state":"IL","postalCode":"60601","country":"USA"}]
  }' | python3 -c "import sys,json; print(json.load(sys.stdin)['id'])")
echo "Created: $ID"</code></pre>

  <h3>PATCH — change one field</h3>
  <pre><code>curl -s -X PATCH "http://localhost:8080/api/v1/customers/$ID" \
  -H "Content-Type: application/merge-patch+json" \
  -d '{"firstName": "Updated"}' | python3 -m json.tool</code></pre>

  <h3>Search by email</h3>
  <pre><code>curl -s "http://localhost:8080/api/v1/customers/search?email=manual@test.com" \
  | python3 -m json.tool</code></pre>

  <h3>Paginate through all customers</h3>
  <pre><code># Page 1
curl -s "http://localhost:8080/api/v1/customers?limit=5" | python3 -m json.tool

# Page 2 (use last id from page 1 as cursor)
curl -s "http://localhost:8080/api/v1/customers?limit=5&amp;after=$LAST_ID" | python3 -m json.tool</code></pre>

  <h3>Trigger a 400 validation error</h3>
  <pre><code>curl -s -X POST http://localhost:8080/api/v1/customers \
  -H "Content-Type: application/json" \
  -d '{"type":"INDIVIDUAL","firstName":"No","lastName":"Contacts"}' \
  | python3 -m json.tool
# → 400 with RFC 7807 problem details listing missing required fields</code></pre>

  <h3>Delete</h3>
  <pre><code>curl -s -X DELETE "http://localhost:8080/api/v1/customers/$ID" -w "HTTP %{http_code}\n"
# → HTTP 204</code></pre>

  <hr />

  <!-- ════════════════════════════════════════════════════════ -->
  <h2 id="grafana-dashboards" class="anchor">Grafana Dashboards</h2>

  <p>Open <a href="http://localhost:3000" target="_blank">http://localhost:3000</a> — no login required (anonymous admin).</p>
  <p>Navigate: left sidebar → <strong>Dashboards</strong> (grid icon) → find the two provisioned dashboards.</p>

  <table>
    <thead><tr><th>Dashboard</th><th>UID / URL</th><th>What you'll see</th></tr></thead>
    <tbody>
      <tr>
        <td><strong>otel-demo — App Overview</strong></td>
        <td><a href="http://localhost:3000/d/app-overview" target="_blank"><code>/d/app-overview</code></a></td>
        <td>Golden signals, JVM, DB pool, Kafka throughput</td>
      </tr>
      <tr>
        <td><strong>otel-demo — HTTP Endpoints</strong></td>
        <td><a href="http://localhost:3000/d/http-endpoints" target="_blank"><code>/d/http-endpoints</code></a></td>
        <td>Per-endpoint drill-down with multi-select filter</td>
      </tr>
    </tbody>
  </table>

  <h3>App Overview panels</h3>
  <ul>
    <li><strong>Request Rate</strong> — requests/second (stat + sparkline)</li>
    <li><strong>Error Rate %</strong> — 4xx+5xx as percentage; green → yellow at 1%, red at 5%</li>
    <li><strong>p50 Latency</strong> — median response time in ms</li>
    <li><strong>p99 Latency</strong> — 99th percentile; yellow at 500ms, red at 2000ms</li>
    <li><strong>Request Rate by Endpoint</strong> — time-series per <code>method route</code> pair</li>
    <li><strong>Response Status Codes</strong> — 2xx (green), 4xx (yellow), 5xx (red) over time</li>
    <li><strong>Latency Percentiles</strong> — p50 / p95 / p99 aggregated across all endpoints</li>
    <li><strong>JVM Heap Memory</strong> — used vs committed vs max bytes</li>
    <li><strong>JVM CPU Utilization</strong> — process CPU ratio 0–1</li>
    <li><strong>DB Connection Pool</strong> — HikariCP idle / used / max</li>
    <li><strong>Kafka Producer Throughput</strong> — bytes/s per topic</li>
  </ul>

  <h3>HTTP Endpoints panels</h3>
  <ul>
    <li><strong>Endpoint selector</strong> — multi-select dropdown populated from Prometheus label values; choose specific routes or "All"</li>
    <li><strong>Stats row</strong> — rate, error %, p50, p99 filtered to selected endpoint(s)</li>
    <li><strong>Request Rate time-series</strong> — traffic per method+route over time</li>
    <li><strong>Status Code breakdown</strong> — 2xx/4xx/5xx for selected endpoints</li>
    <li><strong>Latency Percentiles by Endpoint</strong> — p50/p95/p99 as separate lines per route</li>
    <li><strong>All Endpoints Summary table</strong> — sortable table: Method, Route, req/s, errors/s, p50(ms), p99(ms); p99 and errors columns have colour-coded backgrounds</li>
  </ul>

  <div class="callout info">
    <div class="label">Time range tip</div>
    Dashboards default to <strong>Last 30 minutes</strong>. After running the load test change the
    time picker to <strong>Last 5 minutes</strong> for the sharpest signal. Use <strong>Last 1 hour</strong>
    to see the full session history.
  </div>

  <!-- ════════════════════════════════════════════════════════ -->
  <h2 id="grafana-explore-traces" class="anchor">Explore — Traces (Tempo)</h2>

  <div class="steps">
    <div class="step"><div class="step-num"></div><div class="step-body">
      Click the <strong>compass icon</strong> (Explore) in the left sidebar.
    </div></div>
    <div class="step"><div class="step-num"></div><div class="step-body">
      Select <strong>Tempo</strong> from the datasource dropdown at the top.
    </div></div>
    <div class="step"><div class="step-num"></div><div class="step-body">
      Switch to <strong>Search</strong> tab. Set <em>Service Name</em> = <code>otel-demo</code>.
      Optionally filter by <em>Span Name</em> (e.g. <code>POST /api/v1/customers</code>).
    </div></div>
    <div class="step"><div class="step-num"></div><div class="step-body">
      Click <strong>Run Query</strong>. A table of recent traces appears — each row is one HTTP request.
    </div></div>
    <div class="step"><div class="step-num"></div><div class="step-body">
      Click any trace row to open the <strong>flame graph / waterfall view</strong>.
      You'll see the full span tree: HTTP server → Spring Data → JDBC → Hibernate SQL.
    </div></div>
  </div>

  <h3>What a POST /customers trace looks like</h3>
  <div class="diagram">
 POST /api/v1/customers                                            [0ms … 45ms]
  └─ CustomerController.createCustomer                            [1ms … 44ms]
      └─ CustomerService.create                                   [2ms … 43ms]
          ├─ CustomerRepository.findByEmail (duplicate check)     [2ms … 5ms]
          │    └─ SELECT * FROM customers WHERE … (JDBC)          [2ms … 4ms]
          ├─ CustomerRepository.save                              [8ms … 30ms]
          │    └─ INSERT INTO customers … (JDBC)                  [9ms … 28ms]
          └─ CustomerEventPublisher.publish (Kafka producer)      [35ms … 42ms]
  </div>

  <!-- ════════════════════════════════════════════════════════ -->
  <h2 id="grafana-explore-logs" class="anchor">Explore — Logs (Loki)</h2>

  <div class="steps">
    <div class="step"><div class="step-num"></div><div class="step-body">
      In Explore, select <strong>Loki</strong> from the datasource dropdown.
    </div></div>
    <div class="step"><div class="step-num"></div><div class="step-body">
      Use <strong>Builder</strong> mode. Select label <code>service_name</code> = <code>otel-demo</code>.
    </div></div>
    <div class="step"><div class="step-num"></div><div class="step-body">
      Click <strong>Run Query</strong>. Structured log lines appear with <code>trace_id</code> and
      <code>span_id</code> fields visible in the parsed fields panel.
    </div></div>
    <div class="step"><div class="step-num"></div><div class="step-body">
      Filter to errors: append <code>|= "ERROR"</code> or use label filter <code>level = error</code>.
    </div></div>
    <div class="step"><div class="step-num"></div><div class="step-body">
      To jump from a log line to its trace, click the <strong>Tempo</strong> link icon on any log entry
      that has a non-empty <code>trace_id</code> field.
    </div></div>
  </div>

  <h3>Useful LogQL queries</h3>
  <pre><code># All otel-demo logs
{service_name="otel-demo"}

# Only ERROR level
{service_name="otel-demo"} | logfmt | level="ERROR"

# Requests with slow DB queries (Hibernate DEBUG logs)
{service_name="otel-demo"} |= "Hibernate:" | logfmt

# Find logs for a specific trace
{service_name="otel-demo"} | logfmt | trace_id="4bf92f3577b34da6a3ce929d0e0e4736"</code></pre>

  <!-- ════════════════════════════════════════════════════════ -->
  <h2 id="grafana-explore-metrics" class="anchor">Explore — Metrics (Prometheus)</h2>

  <div class="steps">
    <div class="step"><div class="step-num"></div><div class="step-body">
      In Explore, select <strong>Prometheus</strong>.
    </div></div>
    <div class="step"><div class="step-num"></div><div class="step-body">
      Type a metric name in the query bar (autocomplete is active).
    </div></div>
    <div class="step"><div class="step-num"></div><div class="step-body">
      Click <strong>Run Query</strong>. Switch between <em>Graph</em> and <em>Table</em> views.
    </div></div>
  </div>

  <h3>Key metrics to explore</h3>
  <pre><code># Request rate per endpoint
sum(rate(otel_http_server_request_duration_seconds_count{exported_job="otel-demo"}[5m]))
  by (http_request_method, http_route)

# Error rate %
100 * sum(rate(otel_http_server_request_duration_seconds_count{
    exported_job="otel-demo", http_response_status_code=~"[45].."}[5m]))
  / sum(rate(otel_http_server_request_duration_seconds_count{exported_job="otel-demo"}[5m]))

# p99 latency (ms)
histogram_quantile(0.99,
  sum(rate(otel_http_server_request_duration_seconds_bucket{exported_job="otel-demo"}[5m]))
  by (le, http_route)) * 1000

# JVM heap used (bytes)
sum(otel_jvm_memory_used_bytes{exported_job="otel-demo", jvm_memory_type="heap"})

# DB connections (used)
otel_db_client_connections_usage{exported_job="otel-demo", state="used"}

# Kafka producer bytes/sec
otel_kafka_producer_byte_rate{exported_job="otel-demo"}</code></pre>

  <!-- ════════════════════════════════════════════════════════ -->
  <h2 id="trace-log-correlation" class="anchor">Trace → Log Correlation</h2>

  <p>
    Every log line emitted during a request contains the active <code>trace_id</code> and
    <code>span_id</code> in the MDC (Mapped Diagnostic Context). Grafana Tempo is configured
    to link directly to matching Loki log lines.
  </p>

  <div class="steps">
    <div class="step"><div class="step-num"></div><div class="step-body">
      Open a trace in Tempo (Explore → Tempo → Search → click a trace).
    </div></div>
    <div class="step"><div class="step-num"></div><div class="step-body">
      In the span detail panel, find the <strong>"Logs for this span"</strong> button
      (or the Loki icon). Click it.
    </div></div>
    <div class="step"><div class="step-num"></div><div class="step-body">
      Grafana opens Explore → Loki pre-filtered to <code>{service_name="otel-demo"} | trace_id="…"</code>.
      You see exactly the log lines emitted during that span.
    </div></div>
  </div>

  <div class="callout warn">
    <div class="label">Prerequisite for non-empty trace_id in logs</div>
    The OTel Java agent must be active and instrumentation must not be globally disabled.
    If <code>trace_id=</code> appears empty in log lines, see <a href="#ts-no-traces">No Traces</a>.
  </div>

  <hr />

  <!-- ════════════════════════════════════════════════════════ -->
  <h2 id="ts-no-traces" class="anchor">Troubleshooting — No Traces</h2>

  <h3>Symptom</h3>
  <p>Tempo search returns no results. Log lines show <code>trace_id= span_id=</code> (empty).</p>

  <h3>Diagnosis</h3>
  <pre><code># 1. Is the OTel agent attached?
ps aux | grep javaagent
# Should show: -javaagent:opentelemetry-javaagent.jar

# 2. Is the app sending spans? Enable debug logging
$JAVA_BIN -javaagent:opentelemetry-javaagent.jar \
  -Dotel.javaagent.debug=true \
  ...
# Look for: [opentelemetry-javaagent] INFO ... LoggingSpanExporter - 'POST /api/v1/customers'

# 3. Is the Collector receiving them?
curl http://localhost:55679/debug/tracez
# Check "Running Spans" or "Completed Spans" counts

# 4. Check Collector logs for export errors
podman logs otel_collector_demo 2>&1 | grep -i "error\|fail"</code></pre>

  <h3>Common causes</h3>
  <table>
    <thead><tr><th>Cause</th><th>Fix</th></tr></thead>
    <tbody>
      <tr>
        <td><code>otel.instrumentation.common.default-enabled: false</code> in application-local.yml</td>
        <td>Remove that property entirely from the YAML file</td>
      </tr>
      <tr>
        <td>App started without <code>-javaagent:</code> flag</td>
        <td>Use <code>./infra/start-app.sh</code> or add the flag manually</td>
      </tr>
      <tr>
        <td>Wrong Java binary — app running on Java 25</td>
        <td>Use explicit path: <code>$(/usr/libexec/java_home -v 21)/bin/java</code></td>
      </tr>
      <tr>
        <td>OTel Collector not running or wrong endpoint</td>
        <td>Check <code>docker ps / podman ps</code>; verify <code>-Dotel.exporter.otlp.endpoint=http://localhost:4318</code></td>
      </tr>
      <tr>
        <td>Tempo WAL not flushed yet</td>
        <td>Wait 30–60 seconds after first request; <code>max_block_duration=30s</code> in tempo.yaml</td>
      </tr>
    </tbody>
  </table>

  <!-- ════════════════════════════════════════════════════════ -->
  <h2 id="ts-no-metrics" class="anchor">Troubleshooting — No Metrics</h2>

  <h3>Diagnosis</h3>
  <pre><code># 1. Is the Collector exposing metrics?
curl http://localhost:8889/metrics | grep otel_http
# Should return Prometheus text format with otel_http_server_request_duration_seconds_*

# 2. Is Prometheus scraping the Collector?
curl 'http://localhost:9090/api/v1/targets' | python3 -m json.tool | grep -A5 "otel"
# Should show target health=up

# 3. Does the metric exist in Prometheus?
curl 'http://localhost:9090/api/v1/query?query=otel_http_server_request_duration_seconds_count'</code></pre>

  <h3>Common causes</h3>
  <table>
    <thead><tr><th>Cause</th><th>Fix</th></tr></thead>
    <tbody>
      <tr>
        <td>No requests made yet</td>
        <td>Make at least one API call, wait 30s for Prometheus scrape cycle</td>
      </tr>
      <tr>
        <td>Wrong metric name in dashboard</td>
        <td>Metrics use <code>otel_</code> prefix (OTel agent naming), not <code>http_server_requests_seconds</code> (Micrometer)</td>
      </tr>
      <tr>
        <td>Wrong label: <code>job</code> vs <code>exported_job</code></td>
        <td>Use <code>exported_job="otel-demo"</code> — the Collector relabels the original <code>job</code> to <code>exported_job</code></td>
      </tr>
    </tbody>
  </table>

  <!-- ════════════════════════════════════════════════════════ -->
  <h2 id="ts-no-logs" class="anchor">Troubleshooting — No Logs in Loki</h2>

  <h3>Diagnosis</h3>
  <pre><code># 1. Is Loki receiving logs?
curl -sG http://localhost:3100/loki/api/v1/labels | python3 -m json.tool
# Should include "service_name" label

# 2. Query directly
curl -sG http://localhost:3100/loki/api/v1/query \
  --data-urlencode 'query={service_name="otel-demo"}' \
  --data-urlencode 'limit=5' | python3 -m json.tool

# 3. Check Collector pipeline for log export errors
podman logs otel_collector_demo 2>&1 | grep -i "loki\|log.*error"</code></pre>

  <!-- ════════════════════════════════════════════════════════ -->
  <h2 id="ts-dashboards-empty" class="anchor">Troubleshooting — Empty Grafana Dashboards</h2>

  <h3>Diagnosis checklist</h3>
  <ol>
    <li>Make at least a few API requests, then wait 30–60 seconds (Prometheus scrape + panel refresh).</li>
    <li>Confirm the metric exists: <code>curl 'http://localhost:9090/api/v1/query?query=otel_http_server_request_duration_seconds_count'</code></li>
    <li>Check the dashboard time range — set to <strong>Last 30 minutes</strong> or <strong>Last 5 minutes</strong>.</li>
    <li>Verify the Prometheus datasource UID: Grafana queries use <code>uid: "prometheus"</code>. Check under <em>Connections → Data Sources</em>.</li>
    <li>Check the dashboard panel's query in Edit mode — confirm <code>exported_job="otel-demo"</code>.</li>
  </ol>

  <h3>Dashboard provisioning fails</h3>
  <pre><code># Check Grafana provisioner logs
podman logs grafana_demo 2>&1 | grep -i "provision\|error"

# Typical fix: UIDs in JSON files must match what Grafana has on record
# If you see "could not resolve dashboards:uid:..." → restart the stack
./infra/stop.sh --destroy && ./infra/start.sh</code></pre>

  <!-- ════════════════════════════════════════════════════════ -->
  <h2 id="ts-tempo" class="anchor">Troubleshooting — Tempo Issues</h2>

  <table>
    <thead><tr><th>Symptom</th><th>Cause</th><th>Fix</th></tr></thead>
    <tbody>
      <tr>
        <td><code>empty ring</code> error in logs</td>
        <td>Tempo <code>latest</code> is v3.x with partition ring — incompatible with single-node config</td>
        <td>Pin to <code>grafana/tempo:2.7.1</code> in docker-compose.yml (already done)</td>
      </tr>
      <tr>
        <td><code>field compactor not found</code></td>
        <td>Tempo v3.x removed <code>compactor</code> from single-node config</td>
        <td>Remove <code>compactor</code> block from tempo.yaml (already done)</td>
      </tr>
      <tr>
        <td>Traces visible in Collector but not in Tempo</td>
        <td>WAL not flushed — <code>max_block_duration=30s</code> means traces are queryable after 30s</td>
        <td>Wait 30s after requests, then search in Grafana</td>
      </tr>
      <tr>
        <td><code>/ready</code> returns non-200 for 20+ seconds</td>
        <td>Normal — ingester ring initialisation takes time</td>
        <td>Wait; the app can send spans immediately, Tempo buffers them in WAL</td>
      </tr>
    </tbody>
  </table>

  <hr />

  <!-- ════════════════════════════════════════════════════════ -->
  <h2 id="otel-config" class="anchor">OTel Configuration Reference</h2>

  <h3>Java agent system properties</h3>
  <table>
    <thead><tr><th>Property</th><th>Value</th><th>Purpose</th></tr></thead>
    <tbody>
      <tr><td><code>otel.service.name</code></td><td><code>otel-demo</code></td><td>Appears as service name in Tempo, Loki, Prometheus</td></tr>
      <tr><td><code>otel.exporter.otlp.endpoint</code></td><td><code>http://localhost:4318</code></td><td>OTel Collector HTTP endpoint</td></tr>
      <tr><td><code>otel.exporter.otlp.protocol</code></td><td><code>http/protobuf</code></td><td>HTTP transport (vs gRPC)</td></tr>
      <tr><td><code>otel.traces.sampler</code></td><td><code>always_on</code></td><td>Sample every request (demo setting)</td></tr>
      <tr><td><code>otel.metrics.exporter</code></td><td><code>otlp</code></td><td>Push metrics via OTLP to Collector</td></tr>
      <tr><td><code>otel.logs.exporter</code></td><td><code>otlp</code></td><td>Push logs via OTLP to Collector</td></tr>
    </tbody>
  </table>

  <h3>application-local.yml (Spring profile)</h3>
  <pre><code>otel:
  service:
    name: otel-demo
  metrics:
    exporter: otlp
  traces:
    sampler: always_on
    exporter: otlp
  logs:
    exporter: otlp
  exporter:
    otlp:
      endpoint: http://localhost:4318
      protocol: http/protobuf
  instrumentation:
    kafka:
      experimental-span-attributes: true
      autoconfigure-interceptor: true

# NOTE: Do NOT add otel.instrumentation.common.default-enabled: false
#       This disables ALL auto-instrumentation and produces empty trace IDs</code></pre>

  <!-- ════════════════════════════════════════════════════════ -->
  <h2 id="metric-names" class="anchor">Prometheus Metric Names</h2>

  <div class="callout warn">
    <div class="label">OTel agent vs Micrometer naming</div>
    The OTel Java agent uses the <strong>OpenTelemetry semantic conventions</strong> metric names
    (with <code>otel_</code> prefix after Prometheus relabeling).
    These are different from Micrometer/Spring Actuator metric names
    (e.g. <code>http_server_requests_seconds_count</code>).
    Always use the <code>otel_*</code> names shown below.
  </div>

  <table>
    <thead><tr><th>Metric</th><th>Type</th><th>Key Labels</th><th>Description</th></tr></thead>
    <tbody>
      <tr>
        <td><code>otel_http_server_request_duration_seconds_count</code></td>
        <td>counter</td>
        <td><code>exported_job, http_route, http_request_method, http_response_status_code</code></td>
        <td>Total HTTP requests</td>
      </tr>
      <tr>
        <td><code>otel_http_server_request_duration_seconds_sum</code></td>
        <td>counter</td>
        <td>same</td>
        <td>Total request duration in seconds</td>
      </tr>
      <tr>
        <td><code>otel_http_server_request_duration_seconds_bucket</code></td>
        <td>histogram</td>
        <td>same + <code>le</code></td>
        <td>Request duration histogram buckets (for quantiles)</td>
      </tr>
      <tr>
        <td><code>otel_jvm_memory_used_bytes</code></td>
        <td>gauge</td>
        <td><code>exported_job, jvm_memory_type, jvm_memory_pool_name</code></td>
        <td>JVM memory used</td>
      </tr>
      <tr>
        <td><code>otel_jvm_memory_committed_bytes</code></td>
        <td>gauge</td>
        <td>same</td>
        <td>JVM memory committed to OS</td>
      </tr>
      <tr>
        <td><code>otel_jvm_memory_limit_bytes</code></td>
        <td>gauge</td>
        <td>same</td>
        <td>JVM memory max (-Xmx)</td>
      </tr>
      <tr>
        <td><code>otel_jvm_cpu_recent_utilization_ratio</code></td>
        <td>gauge</td>
        <td><code>exported_job</code></td>
        <td>Process CPU utilization 0–1</td>
      </tr>
      <tr>
        <td><code>otel_db_client_connections_usage</code></td>
        <td>gauge</td>
        <td><code>exported_job, state (idle|used)</code></td>
        <td>HikariCP connection pool state</td>
      </tr>
      <tr>
        <td><code>otel_db_client_connections_max</code></td>
        <td>gauge</td>
        <td><code>exported_job</code></td>
        <td>HikariCP max pool size</td>
      </tr>
      <tr>
        <td><code>otel_kafka_producer_byte_rate</code></td>
        <td>gauge</td>
        <td><code>exported_job, topic</code></td>
        <td>Kafka producer throughput bytes/s</td>
      </tr>
    </tbody>
  </table>

  <div class="callout info">
    <div class="label">Why exported_job?</div>
    Prometheus scrapes metrics from the OTel Collector (not the app directly).
    The Collector's scrape job is named <code>otel-collector</code>.
    The original <code>job="otel-demo"</code> label from the app is automatically renamed
    to <code>exported_job="otel-demo"</code> to avoid collision with Prometheus's own
    <code>job</code> label. Always filter with <code>exported_job="otel-demo"</code>.
  </div>

  <!-- ════════════════════════════════════════════════════════ -->
  <h2 id="key-files" class="anchor">Key Files</h2>

  <table>
    <thead><tr><th>File</th><th>Purpose</th></tr></thead>
    <tbody>
      <tr><td><code>infra/start.sh</code></td><td>Start full observability stack (auto-detects Docker/Podman)</td></tr>
      <tr><td><code>infra/stop.sh</code></td><td>Stop stack; <code>--destroy</code> to wipe volumes</td></tr>
      <tr><td><code>infra/start-app.sh</code></td><td>Build &amp; start Spring Boot with OTel agent</td></tr>
      <tr><td><code>infra/load-test.sh</code></td><td>Sustained load across all endpoints (configurable rounds/pace)</td></tr>
      <tr><td><code>infra/e2e-test.sh</code></td><td>Full lifecycle test with assertions</td></tr>
      <tr><td><code>infra/docker-compose.yml</code></td><td>Container stack definition</td></tr>
      <tr><td><code>infra/otel-collector.yml</code></td><td>OTel Collector pipeline (receivers → processors → exporters)</td></tr>
      <tr><td><code>infra/tempo.yaml</code></td><td>Tempo single-node config (pinned to 2.7.1)</td></tr>
      <tr><td><code>infra/prometheus.yml</code></td><td>Prometheus scrape config (scrapes Collector :8889)</td></tr>
      <tr><td><code>infra/datasources.yaml</code></td><td>Grafana datasources (Prometheus, Tempo, Loki) with trace↔log links</td></tr>
      <tr><td><code>infra/grafana/dashboards/app-overview.json</code></td><td>Golden signals dashboard JSON</td></tr>
      <tr><td><code>infra/grafana/dashboards/http-endpoints.json</code></td><td>Per-endpoint drill-down dashboard JSON</td></tr>
      <tr><td><code>src/main/resources/application-local.yml</code></td><td>Local profile: OTel endpoint, DB, Kafka, Flyway</td></tr>
      <tr><td><code>opentelemetry-javaagent.jar</code></td><td>OTel Java agent (project root — not committed to git)</td></tr>
    </tbody>
  </table>

  <hr />
  <p class="muted" style="text-align:center; margin: 2rem 0;">
    otel-demo — Spring Boot 3.5 · OpenTelemetry Java Agent 2.x · Grafana 11.4 · Tempo 2.7.1
  </p>

</main>
</div>
</body>
</html>
